<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分布式链路追踪原理 - 可视化演示</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* 背景层级 - GitHub Dark 风格 */
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-active: #30363d;

            /* 文字颜色 */
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;

            /* 强调色 */
            --accent-primary: #58a6ff;
            --accent-success: #3fb950;
            --accent-warning: #d29922;
            --accent-danger: #f85149;
            --accent-purple: #a371f7;
            --accent-cyan: #39c5cf;

            /* 模块主题色 */
            --theme-problem: #f85149;
            --theme-concept: #58a6ff;
            --theme-traceid: #a371f7;
            --theme-solution: #3fb950;
            --theme-practice: #d29922;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .page-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* 顶部标题栏 */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--bg-tertiary);
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .app-title {
            font-size: 18px;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--bg-active);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: var(--bg-active);
            transform: translateY(-1px);
        }

        /* 主容器 */
        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* 左侧导航 */
        .nav-panel {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--bg-tertiary);
            padding: 16px 0;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .nav-section-title {
            padding: 8px 16px;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .nav-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-size: 14px;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
        }

        .nav-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--text-muted);
        }

        .nav-item.active .nav-dot {
            background: var(--accent-primary);
        }

        /* 主舞台 */
        .main-stage {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .module-stage {
            width: 100%;
            height: 100%;
            display: none;
        }

        .module-stage.active {
            display: block;
        }

        .stage-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .stage-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stage-description {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .canvas-container {
            width: 100%;
            height: calc(100% - 120px);
            position: relative;
            overflow: hidden;
        }

        /* SVG 样式 */
        .animation-canvas {
            width: 100%;
            height: 100%;
        }

        /* 代码解释浮窗 */
        .code-explanation {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 200px;
            background: rgba(13, 17, 23, 0.95);
            border: 1px solid var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .code-explanation.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .code-title {
            font-size: 13px;
            color: var(--accent-primary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .code-content {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .code-content code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--accent-primary);
            font-family: 'Consolas', 'Monaco', monospace;
        }

        /* 控制面板 */
        .control-panel {
            background: var(--bg-secondary);
            border-top: 1px solid var(--bg-tertiary);
            padding: 12px 20px;
            flex-shrink: 0;
        }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--bg-active);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-btn:hover:not(:disabled) {
            background: var(--bg-active);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .control-btn:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-btn.primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #000;
        }

        .control-btn.primary:hover:not(:disabled) {
            background: #4c8ed9;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            max-width: 500px;
        }

        .progress-dots {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            transition: all 0.3s;
        }

        .progress-dot.active {
            background: var(--accent-primary);
            transform: scale(1.3);
        }

        .progress-dot.completed {
            background: var(--accent-success);
        }

        .progress-line {
            flex: 1;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-success));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .step-counter {
            font-size: 13px;
            color: var(--text-secondary);
            min-width: 60px;
            text-align: right;
        }

        /* 速度选择器 */
        .speed-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .speed-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .speed-btn {
            padding: 4px 8px;
            font-size: 11px;
            background: var(--bg-tertiary);
            border: 1px solid var(--bg-active);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .speed-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #000;
        }

        /* SVG 元素样式 */
        .service-box {
            cursor: pointer;
            transition: filter 0.3s;
        }

        .service-box:hover {
            filter: brightness(1.2);
        }

        .data-packet {
            filter: drop-shadow(0 0 6px currentColor);
        }

        .trace-badge {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .nav-panel {
                position: fixed;
                left: -280px;
                z-index: 100;
                transition: left 0.3s;
            }

            .nav-panel.open {
                left: 0;
            }

            .code-explanation {
                width: calc(100% - 40px);
                max-height: 40vh;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- 顶部标题栏 -->
        <header class="app-header">
            <div class="header-left">
                <div class="app-title">分布式链路追踪原理</div>
            </div>
            <div class="header-controls">
                <button class="header-btn" onclick="toggleFullscreen()">⛶ 全屏</button>
                <button class="header-btn" onclick="showHelp()">? 帮助</button>
            </div>
        </header>

        <!-- 主容器 -->
        <div class="app-container">
            <!-- 左侧导航 -->
            <nav class="nav-panel">
                <div class="nav-section-title">模块列表</div>
                <div class="nav-item" data-module="1" style="border-left-color: var(--theme-problem);">
                    <div class="nav-dot" style="background: var(--theme-problem);"></div>
                    <span>为什么需要链路追踪</span>
                </div>
                <div class="nav-item" data-module="2" style="border-left-color: var(--theme-concept);">
                    <div class="nav-dot" style="background: var(--theme-concept);"></div>
                    <span>核心概念：Trace与Span</span>
                </div>
                <div class="nav-item" data-module="3" style="border-left-color: var(--theme-traceid);">
                    <div class="nav-dot" style="background: var(--theme-traceid);"></div>
                    <span>TraceId全链路传递</span>
                </div>
                <div class="nav-item" data-module="4" style="border-left-color: var(--theme-solution);">
                    <div class="nav-dot" style="background: var(--theme-solution);"></div>
                    <span>主流解决方案</span>
                </div>
                <div class="nav-item" data-module="5" style="border-left-color: var(--theme-practice);">
                    <div class="nav-dot" style="background: var(--theme-practice);"></div>
                    <span>实际应用与最佳实践</span>
                </div>
            </nav>

            <!-- 主舞台 -->
            <main class="main-stage">
                <!-- 模块1：为什么需要链路追踪 -->
                <section class="module-stage active" data-module="1">
                    <div class="stage-header">
                        <h2 class="stage-title">为什么需要链路追踪</h2>
                        <p class="stage-description">理解微服务架构下的调用复杂性与问题定位困境</p>
                    </div>
                    <div class="canvas-container">
                        <svg class="animation-canvas" id="canvas1" viewBox="0 0 1200 600"></svg>
                        <div class="code-explanation" id="explanation1"></div>
                    </div>
                </section>

                <!-- 模块2：核心概念 -->
                <section class="module-stage" data-module="2">
                    <div class="stage-header">
                        <h2 class="stage-title">核心概念：Trace与Span</h2>
                        <p class="stage-description">理解链路追踪的数据模型和核心概念</p>
                    </div>
                    <div class="canvas-container">
                        <svg class="animation-canvas" id="canvas2" viewBox="0 0 1200 600"></svg>
                        <div class="code-explanation" id="explanation2"></div>
                    </div>
                </section>

                <!-- 模块3：TraceId传递 -->
                <section class="module-stage" data-module="3">
                    <div class="stage-header">
                        <h2 class="stage-title">TraceId全链路传递</h2>
                        <p class="stage-description">TraceId如何在分布式系统中传递</p>
                    </div>
                    <div class="canvas-container">
                        <svg class="animation-canvas" id="canvas3" viewBox="0 0 1200 600"></svg>
                        <div class="code-explanation" id="explanation3"></div>
                    </div>
                </section>

                <!-- 模块4：主流解决方案 -->
                <section class="module-stage" data-module="4">
                    <div class="stage-header">
                        <h2 class="stage-title">主流解决方案</h2>
                        <p class="stage-description">Jaeger、Zipkin、SkyWalking对比</p>
                    </div>
                    <div class="canvas-container">
                        <svg class="animation-canvas" id="canvas4" viewBox="0 0 1200 600"></svg>
                        <div class="code-explanation" id="explanation4"></div>
                    </div>
                </section>

                <!-- 模块5：实际应用 -->
                <section class="module-stage" data-module="5">
                    <div class="stage-header">
                        <h2 class="stage-title">实际应用与最佳实践</h2>
                        <p class="stage-description">慢查询定位、性能分析、采样策略</p>
                    </div>
                    <div class="canvas-container">
                        <svg class="animation-canvas" id="canvas5" viewBox="0 0 1200 600"></svg>
                        <div class="code-explanation" id="explanation5"></div>
                    </div>
                </section>
            </main>
        </div>

        <!-- 控制面板 -->
        <footer class="control-panel">
            <div class="control-row">
                <div class="control-buttons">
                    <button class="control-btn" id="prevBtn">◀ 上一步</button>
                    <button class="control-btn primary" id="nextBtn">下一步 ▶</button>
                    <button class="control-btn" id="resetBtn">↺ 重置</button>
                    <button class="control-btn" id="autoPlayBtn">▶ 自动演示</button>
                </div>

                <div class="progress-container">
                    <div class="progress-dots" id="progressDots"></div>
                    <div class="progress-line">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="step-counter" id="stepCounter">0 / 0</div>
                </div>

                <div class="speed-selector">
                    <span class="speed-label">速度:</span>
                    <button class="speed-btn" data-speed="0.5">0.5x</button>
                    <button class="speed-btn active" data-speed="1">1x</button>
                    <button class="speed-btn" data-speed="1.5">1.5x</button>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // 模块配置
        const ModuleConfig = {
            1: { title: "为什么需要链路追踪", steps: 3, theme: "var(--theme-problem)" },
            2: { title: "核心概念：Trace与Span", steps: 4, theme: "var(--theme-concept)" },
            3: { title: "TraceId全链路传递", steps: 5, theme: "var(--theme-traceid)" },
            4: { title: "主流解决方案", steps: 3, theme: "var(--theme-solution)" },
            5: { title: "实际应用与最佳实践", steps: 4, theme: "var(--theme-practice)" }
        };

        // 解释文本
        const Explanations = {
            1: {
                0: "点击「下一步」开始演示微服务架构下的调用复杂性",
                1: "【单体应用时代】所有功能在一个进程中，问题定位简单：查看日志即可找到错误",
                2: "【微服务时代】一个请求经过多个服务，每个服务有多个实例。用户反馈「系统很慢」，但你知道请求卡在哪里吗？",
                3: "【问题】传统日志方式难以追踪：1) 日志分散在不同服务器 2) 缺少关联关系 3) 无法完整还原调用链路"
            },
            2: {
                0: "点击「下一步」学习链路追踪的核心概念",
                1: "【Trace - 追踪链路】代表一个完整的请求链路，例如：用户下单 → 创建订单 → 扣减库存 → 支付 → 发送通知。一个Trace有唯一的TraceId。",
                2: "【Span - 跨度】代表单个服务内的调用，例如：订单服务查询数据库。每个Span有唯一的SpanId，记录开始时间、结束时间、操作名称等。",
                3: "【Span关系】Span之间形成树形结构：Root Span（网关）的子Span是各个服务调用的Span。通过ParentSpanId建立父子关系。",
                4: "【完整模型】Trace = 多个Span组成的树。示例：TraceId=abc123包含：网关Span → 订单Span → 库存Span，形成完整的调用链树。"
            },
            3: {
                0: "点击「下一步」观看TraceId如何在系统中传递",
                1: "【Step 1】用户发起请求，网关生成TraceId（如：abc123）和RootSpanId（如：span1）",
                2: "【Step 2】网关调用订单服务，通过HTTP请求头传递：X-Trace-Id: abc123, X-Parent-Span-Id: span1",
                3: "【Step 3】订单服务创建自己的SpanId（span2），记录ParentSpanId=span1。然后调用库存服务，继续传递TraceId和ParentSpanId",
                4: "【Step 4】库存服务创建SpanId（span3），记录ParentSpanId=span2。查询数据库操作也创建子Span（span4）",
                5: "【ThreadLocal传递】同一服务内，使用ThreadLocal存储TraceId，确保异步线程、线程池也能获取到TraceId，避免链路中断"
            },
            4: {
                0: "点击「下一步」了解主流链路追踪方案",
                1: "【Jaeger】Uber开源，CNCF毕业项目。架构：Agent（采集）→ Collector（收集）→ Storage（存储）→ UI（查询）。支持OpenTelemetry标准。",
                2: "【Zipkin】Twitter开源，链路追踪鼻祖。架构：Reporter（上报）→ Collector → Storage → UI。轻量级，社区活跃。",
                3: "【SkyWalking】国产开源，昊佳佳主导。APM一体化平台：链路追踪 + 性能监控 + 告警。支持Java自动探针，无侵入接入。"
            },
            5: {
                0: "点击「下一步」学习实际应用场景",
                1: "【场景1：慢查询定位】用户反馈「订单接口很慢」。在链路追踪UI中搜索该订单号，发现库存服务查询数据库耗时2.5秒（红色高亮），立即定位问题。",
                2: "【场景2：性能瓶颈分析】查看Trace的瀑布图，发现所有请求在「优惠券服务」耗时过长。分析原因：数据库索引缺失，添加索引后性能提升10倍。",
                3: "【场景3：采样策略】链路追踪有性能损耗，不能100%采集。建议：生产环境采样率10%（每10个请求记录1个），开发环境100%。只记录慢请求（如耗时>1秒）。",
                4: "【最佳实践】1) 链路追踪 + 日志关联（日志中记录TraceId） 2) 链路追踪 + 监控告警（慢请求自动告警） 3) 定期分析Top 10慢请求，持续优化"
            }
        };

        // 主控制器类
        class AnimationController {
            constructor() {
                this.currentModule = 1;
                this.currentStep = {};
                this.isAnimating = false;
                this.timelines = {};
                this.speed = 1;
                this.isAutoPlaying = false;
                this.init();
            }

            init() {
                this.bindEvents();
                this.initModule1();
                this.initModule2();
                this.initModule3();
                this.initModule4();
                this.initModule5();
                this.updateProgress();
                this.showExplanation(1, 0);
            }

            bindEvents() {
                // 模块切换
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const module = parseInt(item.dataset.module);
                        this.switchModule(module);
                    });
                });

                // 键盘快捷键
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowRight' || e.key === ' ') {
                        e.preventDefault();
                        this.nextStep();
                    } else if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        this.prevStep();
                    } else if (e.key === 'r' || e.key === 'R') {
                        this.reset();
                    } else if (e.key === 'f' || e.key === 'F') {
                        toggleFullscreen();
                    }
                });
            }

            switchModule(moduleNum) {
                if (moduleNum === this.currentModule) return;

                // 清理旧timeline
                if (this.timelines[this.currentModule]) {
                    this.timelines[this.currentModule].kill();
                    delete this.timelines[this.currentModule];
                }

                // 切换导航状态
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (parseInt(item.dataset.module) === moduleNum) {
                        item.classList.add('active');
                    }
                });

                // 切换舞台
                document.querySelectorAll('.module-stage').forEach(stage => {
                    stage.classList.remove('active');
                    if (parseInt(stage.dataset.module) === moduleNum) {
                        stage.classList.add('active');
                    }
                });

                this.currentModule = moduleNum;
                this.currentStep[moduleNum] = 0;
                this.initModule(moduleNum);
                this.updateProgress();
                this.showExplanation(moduleNum, 0);
            }

            initModule(moduleNum) {
                switch(moduleNum) {
                    case 1: this.initModule1(); break;
                    case 2: this.initModule2(); break;
                    case 3: this.initModule3(); break;
                    case 4: this.initModule4(); break;
                    case 5: this.initModule5(); break;
                }
            }

            // ============ 模块1：为什么需要链路追踪 ============
            initModule1() {
                const svg = document.getElementById('canvas1');
                svg.innerHTML = '';
                const tl = gsap.timeline({ paused: true });

                this.createBackground(svg);
                tl.add('step0');

                // Step 1: 单体应用展示
                const monolithGroup = this.createMonolithApp(svg, 200, 250);
                gsap.set(monolithGroup, { opacity: 0 });

                tl.to(monolithGroup, { opacity: 1, duration: 0.5 }, 'step1');

                const user = this.createUser(svg, 50, 280);
                const request1 = this.createRequestPacket(svg, '用户请求', 100, 280, '#58a6ff');
                gsap.set([user, request1], { opacity: 0 });

                tl.to([user, request1], { opacity: 1, duration: 0.5 }, 'step1');
                tl.to(request1, { x: 180, duration: 1, ease: 'power2.inOut' }, 'step1 += 0.5');
                tl.add('step1');

                // Step 2: 微服务架构展示
                const microservicesGroup = this.createMicroservices(svg, 150, 150);
                gsap.set(microservicesGroup, { opacity: 0, scale: 0.8 });

                tl.to(microservicesGroup, {
                    opacity: 1,
                    scale: 1,
                    duration: 0.6,
                    transformOrigin: 'center center'
                }, 'step2');

                tl.to(monolithGroup, {
                    opacity: 0,
                    scale: 0.8,
                    duration: 0.4,
                    transformOrigin: 'center center'
                }, 'step2');

                const requests = [];
                const services = [
                    { x: 350, y: 200, name: '网关' },
                    { x: 550, y: 150, name: '订单' },
                    { x: 550, y: 280, name: '库存' },
                    { x: 750, y: 200, name: '支付' }
                ];

                services.forEach((svc, i) => {
                    const req = this.createRequestPacket(svg, `请求${i + 1}`, 0, 0, '#58a6ff');
                    gsap.set(req, { opacity: 0 });
                    requests.push({ element: req, targetX: svc.x - 30, targetY: svc.y });
                });

                tl.to(requests.map(r => r.element), { opacity: 1, duration: 0.4 }, 'step2 += 0.3');

                requests.forEach((req, i) => {
                    tl.to(req.element, {
                        x: req.targetX,
                        y: req.targetY,
                        duration: 0.8,
                        ease: 'power2.inOut'
                    }, `step2 += ${0.5 + i * 0.2}`);
                });

                tl.add('step2');

                // Step 3: 问题展示
                const problemText = this.createProblemText(svg, 500, 450);
                gsap.set(problemText, { opacity: 0 });

                tl.to(problemText, { opacity: 1, duration: 0.5 }, 'step3');

                // 让其中一个服务变红（慢请求）- 修复SVG className错误
                const slowService = svg.querySelector('[data-service="库存"]');
                if (slowService) {
                    tl.to(slowService, {
                        stroke: '#f85149',
                        strokeWidth: 3,
                        duration: 0.3
                    }, 'step3');

                    // 使用 GSAP 动画实现慢请求警告效果（脉冲动画）
                    const slowAnimation = gsap.to(slowService.querySelector('rect'), {
                        attr: { strokeOpacity: 0.4 },
                        duration: 0.75,
                        yoyo: true,
                        repeat: -1,
                        ease: 'power1.inOut'
                    });
                    slowService._slowAnimation = slowAnimation;
                }

                tl.add('step3');

                this.timelines[1] = tl;
                this.currentStep[1] = 0;
            }

            // ============ 模块2：核心概念 ============
            initModule2() {
                const svg = document.getElementById('canvas2');
                svg.innerHTML = '';
                const tl = gsap.timeline({ paused: true });

                this.createBackground(svg);
                tl.add('step0');

                const traceGroup = this.createTraceVisualization(svg, 100, 150);
                gsap.set(traceGroup, { opacity: 0, y: -20 });
                tl.to(traceGroup, { opacity: 1, y: 0, duration: 0.6 }, 'step1');
                tl.add('step1');

                const spanGroup = this.createSpanVisualization(svg, 100, 320);
                gsap.set(spanGroup, { opacity: 0, y: -20 });
                tl.to(spanGroup, { opacity: 1, y: 0, duration: 0.6 }, 'step2');
                tl.add('step2');

                const relationGroup = this.createSpanRelation(svg, 550, 100);
                gsap.set(relationGroup, { opacity: 0, scale: 0.9 });
                tl.to(relationGroup, { opacity: 1, scale: 1, duration: 0.6, transformOrigin: 'center center' }, 'step3');
                tl.add('step3');

                const fullModel = this.createFullTraceModel(svg, 550, 350);
                gsap.set(fullModel, { opacity: 0 });
                tl.to(fullModel, { opacity: 1, duration: 0.6 }, 'step4');
                tl.add('step4');

                this.timelines[2] = tl;
                this.currentStep[2] = 0;
            }

            // ============ 模块3：TraceId传递 ============
            initModule3() {
                const svg = document.getElementById('canvas3');
                svg.innerHTML = '';
                const tl = gsap.timeline({ paused: true });

                this.createBackground(svg);
                tl.add('step0');

                const services = this.createServiceChain(svg);
                gsap.set(services, { opacity: 0 });

                tl.to(services, { opacity: 1, duration: 0.5 }, 'step1');

                const user = this.createUser(svg, 30, 300);
                const traceIdBadge = this.createTraceIdBadge(svg, 'abc123', 120, 250);
                gsap.set([user, traceIdBadge], { opacity: 0, scale: 0.8 });

                tl.to([user, traceIdBadge], {
                    opacity: 1,
                    scale: 1,
                    duration: 0.5,
                    transformOrigin: 'center center'
                }, 'step1 += 0.3');

                tl.add('step1');

                const steps = [
                    { targetX: 250, label: '传递TraceId' },
                    { targetX: 450, label: '创建Span2' },
                    { targetX: 650, label: '创建Span3' },
                    { targetX: 850, label: '查询DB' }
                ];

                steps.forEach((step, i) => {
                    const packet = this.createDataPacket(svg, 'TraceId', 180, 300, '#a371f7');
                    gsap.set(packet, { opacity: 0 });

                    tl.to(packet, { opacity: 1, duration: 0.3 }, `step${i + 2}`);
                    tl.to(packet, { x: step.targetX, duration: 0.8, ease: 'power2.inOut' }, `step${i + 2} += 0.3`);

                    const copyBadge = this.createTraceIdBadge(svg, 'abc123', step.targetX + 60, 250);
                    gsap.set(copyBadge, { opacity: 0, scale: 0.5 });

                    tl.to(copyBadge, {
                        opacity: 1,
                        scale: 1,
                        duration: 0.3,
                        transformOrigin: 'center center'
                    }, `step${i + 2} += 1.1`);

                    tl.to(packet, { opacity: 0, duration: 0.2 }, `step${i + 2} += 1.4`);
                    tl.add(`step${i + 2}`);
                });

                this.timelines[3] = tl;
                this.currentStep[3] = 0;
            }

            // ============ 模块4：主流解决方案 ============
            initModule4() {
                const svg = document.getElementById('canvas4');
                svg.innerHTML = '';
                const tl = gsap.timeline({ paused: true });

                this.createBackground(svg);
                tl.add('step0');

                const solutions = ['Jaeger', 'Zipkin', 'SkyWalking'];
                const colors = ['#3fb950', '#58a6ff', '#d29922'];

                solutions.forEach((name, i) => {
                    const group = this.createSolutionCard(svg, name, 100 + i * 370, 150, colors[i]);
                    gsap.set(group, { opacity: 0, y: 30 });

                    tl.to(group, { opacity: 1, y: 0, duration: 0.5 }, `step${i + 1}`);
                    tl.add(`step${i + 1}`);
                });

                this.timelines[4] = tl;
                this.currentStep[4] = 0;
            }

            // ============ 模块5：实际应用 ============
            initModule5() {
                const svg = document.getElementById('canvas5');
                svg.innerHTML = '';
                const tl = gsap.timeline({ paused: true });

                this.createBackground(svg);
                tl.add('step0');

                const waterfall = this.createWaterfallChart(svg, 100, 150);
                gsap.set(waterfall, { opacity: 0 });
                tl.to(waterfall, { opacity: 1, duration: 0.6 }, 'step1');

                const slowBar = svg.querySelector('.slow-bar');
                if (slowBar) {
                    gsap.set(slowBar, { fill: '#f85149' });
                    tl.from(slowBar, { fill: '#58a6ff', duration: 0.3 }, 'step1 += 0.6');
                }

                tl.add('step1');

                const analysis = this.createPerformanceAnalysis(svg, 600, 150);
                gsap.set(analysis, { opacity: 0 });
                tl.to(analysis, { opacity: 1, duration: 0.6 }, 'step2');
                tl.add('step2');

                const sampling = this.createSamplingStrategy(svg, 100, 350);
                gsap.set(sampling, { opacity: 0 });
                tl.to(sampling, { opacity: 1, duration: 0.6 }, 'step3');
                tl.add('step3');

                const practices = this.createBestPractices(svg, 600, 350);
                gsap.set(practices, { opacity: 0 });
                tl.to(practices, { opacity: 1, duration: 0.6 }, 'step4');
                tl.add('step4');

                this.timelines[5] = tl;
                this.currentStep[5] = 0;
            }

            // ============ SVG创建辅助方法 ============

            createBackground(svg) {
                const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                bg.setAttribute('width', '1200');
                bg.setAttribute('height', '600');
                bg.setAttribute('fill', '#0d1117');
                svg.appendChild(bg);

                for (let i = 0; i < 1200; i += 50) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', i);
                    line.setAttribute('y1', '0');
                    line.setAttribute('x2', i);
                    line.setAttribute('y2', '600');
                    line.setAttribute('stroke', '#21262d');
                    line.setAttribute('stroke-width', '1');
                    line.setAttribute('opacity', '0.3');
                    svg.appendChild(line);
                }
            }

            createUser(svg, x, y) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('r', '20');
                circle.setAttribute('fill', '#58a6ff');
                group.appendChild(circle);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('y', '5');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#000');
                text.setAttribute('font-size', '12');
                text.setAttribute('font-weight', 'bold');
                text.textContent = '用户';
                group.appendChild(text);

                svg.appendChild(group);
                return group;
            }

            createRequestPacket(svg, text, x, y, color) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '80');
                rect.setAttribute('height', '30');
                rect.setAttribute('rx', '4');
                rect.setAttribute('fill', color);
                group.appendChild(rect);

                const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                textEl.setAttribute('x', '40');
                textEl.setAttribute('y', '19');
                textEl.setAttribute('text-anchor', 'middle');
                textEl.setAttribute('fill', '#000');
                textEl.setAttribute('font-size', '11');
                textEl.textContent = text;
                group.appendChild(textEl);

                svg.appendChild(group);
                return group;
            }

            createMonolithApp(svg, x, y) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '200');
                rect.setAttribute('height', '180');
                rect.setAttribute('rx', '8');
                rect.setAttribute('fill', '#21262d');
                rect.setAttribute('stroke', '#58a6ff');
                rect.setAttribute('stroke-width', '2');
                group.appendChild(rect);

                const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                title.setAttribute('x', '100');
                title.setAttribute('y', '30');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('fill', '#e6edf3');
                title.setAttribute('font-size', '14');
                title.setAttribute('font-weight', 'bold');
                title.textContent = '单体应用';
                group.appendChild(title);

                const modules = ['用户模块', '订单模块', '库存模块', '支付模块'];
                modules.forEach((mod, i) => {
                    const modRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    modRect.setAttribute('x', '20');
                    modRect.setAttribute('y', 50 + i * 30);
                    modRect.setAttribute('width', '160');
                    modRect.setAttribute('height', '25');
                    modRect.setAttribute('rx', '4');
                    modRect.setAttribute('fill', '#30363d');
                    group.appendChild(modRect);

                    const modText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    modText.setAttribute('x', '100');
                    modText.setAttribute('y', 67 + i * 30);
                    modText.setAttribute('text-anchor', 'middle');
                    modText.setAttribute('fill', '#8b949e');
                    modText.setAttribute('font-size', '11');
                    modText.textContent = mod;
                    group.appendChild(modText);
                });

                svg.appendChild(group);
                return group;
            }

            createMicroservices(svg, startX, startY) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');

                const services = [
                    { name: '网关服务', x: 300, y: 180 },
                    { name: '订单服务', x: 500, y: 120 },
                    { name: '库存服务', x: 500, y: 240 },
                    { name: '支付服务', x: 700, y: 180 }
                ];

                services.forEach(svc => {
                    const serviceGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    serviceGroup.setAttribute('data-service', svc.name.replace('服务', ''));

                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', svc.x);
                    rect.setAttribute('y', svc.y);
                    rect.setAttribute('width', '120');
                    rect.setAttribute('height', '60');
                    rect.setAttribute('rx', '6');
                    rect.setAttribute('fill', '#21262d');
                    rect.setAttribute('stroke', '#58a6ff');
                    rect.setAttribute('stroke-width', '2');
                    serviceGroup.appendChild(rect);

                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', svc.x + 60);
                    text.setAttribute('y', svc.y + 35);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#e6edf3');
                    text.setAttribute('font-size', '12');
                    text.setAttribute('font-weight', 'bold');
                    text.textContent = svc.name;
                    serviceGroup.appendChild(text);

                    group.appendChild(serviceGroup);
                });

                svg.appendChild(group);
                return group;
            }

            createProblemText(svg, x, y) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const problems = [
                    '❓ 用户反馈：系统很慢',
                    '❓ 查看日志：分散在不同服务器',
                    '❓ 缺少关联：无法还原完整链路'
                ];

                problems.forEach((prob, i) => {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('y', i * 25);
                    text.setAttribute('fill', '#f85149');
                    text.setAttribute('font-size', '13');
                    text.textContent = prob;
                    group.appendChild(text);
                });

                svg.appendChild(group);
                return group;
            }

            createTraceVisualization(svg, x, y) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '400');
                rect.setAttribute('height', '140');
                rect.setAttribute('rx', '8');
                rect.setAttribute('fill', '#21262d');
                rect.setAttribute('stroke', '#a371f7');
                rect.setAttribute('stroke-width', '2');
                group.appendChild(rect);

                const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                title.setAttribute('x', '200');
                title.setAttribute('y', '25');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('fill', '#a371f7');
                title.setAttribute('font-size', '14');
                title.setAttribute('font-weight', 'bold');
                title.textContent = 'Trace - 完整调用链';
                group.appendChild(title);

                const traceId = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                traceId.setAttribute('x', '200');
                traceId.setAttribute('y', '50');
                traceId.setAttribute('text-anchor', 'middle');
                traceId.setAttribute('fill', '#58a6ff');
                traceId.setAttribute('font-size', '12');
                traceId.setAttribute('font-family', 'monospace');
                traceId.textContent = 'TraceId: abc123';
                group.appendChild(traceId);

                const chain = ['用户', '→ 网关', '→ 订单', '→ 库存', '→ 支付'];
                const chainText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                chainText.setAttribute('x', '200');
                chainText.setAttribute('y', '90');
                chainText.setAttribute('text-anchor', 'middle');
                chainText.setAttribute('fill', '#8b949e');
                chainText.setAttribute('font-size', '12');
                chainText.textContent = chain.join(' ');
                group.appendChild(chainText);

                const desc = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                desc.setAttribute('x', '200');
                desc.setAttribute('y', '120');
                desc.setAttribute('text-anchor', 'middle');
                desc.setAttribute('fill', '#6e7681');
                desc.setAttribute('font-size', '11');
                desc.textContent = '代表一个完整的请求链路，从用户发起到最后响应';
                group.appendChild(desc);

                svg.appendChild(group);
                return group;
            }

            createSpanVisualization(svg, x, y) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '400');
                rect.setAttribute('height', '120');
                rect.setAttribute('rx', '8');
                rect.setAttribute('fill', '#21262d');
                rect.setAttribute('stroke', '#58a6ff');
                rect.setAttribute('stroke-width', '2');
                group.appendChild(rect);

                const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                title.setAttribute('x', '200');
                title.setAttribute('y', '25');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('fill', '#58a6ff');
                title.setAttribute('font-size', '14');
                title.setAttribute('font-weight', 'bold');
                title.textContent = 'Span - 单个调用';
                group.appendChild(title);

                const fields = [
                    'SpanId: span001',
                    'ParentSpanId: span000',
                    '操作: 查询数据库',
                    '耗时: 125ms'
                ];

                fields.forEach((field, i) => {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', '200');
                    text.setAttribute('y', 50 + i * 18);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#8b949e');
                    text.setAttribute('font-size', '11');
                    text.setAttribute('font-family', 'monospace');
                    text.textContent = field;
                    group.appendChild(text);
                });

                svg.appendChild(group);
                return group;
            }

            createSpanRelation(svg, x, y) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const spans = [
                    { id: 'Root', label: 'Root Span (网关)', level: 0 },
                    { id: 'A', label: 'Span A (订单)', level: 1 },
                    { id: 'B', label: 'Span B (库存)', level: 1 },
                    { id: 'C', label: 'Span C (DB查询)', level: 2 }
                ];

                const lines = [
                    { from: 0, to: 1 },
                    { from: 0, to: 2 },
                    { from: 1, to: 3 }
                ];

                lines.forEach(line => {
                    const fromSpan = spans[line.from];
                    const toSpan = spans[line.to];
                    const lineEl = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    lineEl.setAttribute('x1', 200);
                    lineEl.setAttribute('y1', 40 + fromSpan.level * 50);
                    lineEl.setAttribute('x2', 200);
                    lineEl.setAttribute('y2', 40 + toSpan.level * 50);
                    lineEl.setAttribute('stroke', '#58a6ff');
                    lineEl.setAttribute('stroke-width', '2');
                    group.appendChild(lineEl);
                });

                spans.forEach((span, i) => {
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', 50);
                    rect.setAttribute('y', 20 + i * 50);
                    rect.setAttribute('width', '300');
                    rect.setAttribute('height', '35');
                    rect.setAttribute('rx', '4');
                    rect.setAttribute('fill', i === 0 ? '#30363d' : '#21262d');
                    rect.setAttribute('stroke', '#58a6ff');
                    rect.setAttribute('stroke-width', '1');
                    group.appendChild(rect);

                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', '200');
                    text.setAttribute('y', 42 + i * 50);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#e6edf3');
                    text.setAttribute('font-size', '11');
                    text.textContent = span.label;
                    group.appendChild(text);
                });

                svg.appendChild(group);
                return group;
            }

            createFullTraceModel(svg, x, y) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '500');
                rect.setAttribute('height', '130');
                rect.setAttribute('rx', '8');
                rect.setAttribute('fill', '#21262d');
                rect.setAttribute('stroke', '#3fb950');
                rect.setAttribute('stroke-width', '2');
                group.appendChild(rect);

                const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                title.setAttribute('x', '250');
                title.setAttribute('y', '25');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('fill', '#3fb950');
                title.setAttribute('font-size', '14');
                title.setAttribute('font-weight', 'bold');
                title.textContent = '完整模型：Trace = Span树';
                group.appendChild(title);

                const formula = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                formula.setAttribute('x', '250');
                formula.setAttribute('y', '55');
                formula.setAttribute('text-anchor', 'middle');
                formula.setAttribute('fill', '#58a6ff');
                formula.setAttribute('font-size', '12');
                formula.setAttribute('font-family', 'monospace');
                formula.textContent = 'TraceId: abc123 = [Root, SpanA, SpanB, SpanC...]';
                group.appendChild(formula);

                const desc = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                desc.setAttribute('x', '250');
                desc.setAttribute('y', '85');
                desc.setAttribute('text-anchor', 'middle');
                desc.setAttribute('fill', '#8b949e');
                desc.setAttribute('font-size', '11');
                desc.textContent = '通过ParentSpanId建立树形关系，完整还原调用链路';
                group.appendChild(desc);

                const tip = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                tip.setAttribute('x', '250');
                tip.setAttribute('y', '110');
                tip.setAttribute('text-anchor', 'middle');
                tip.setAttribute('fill', '#d29922');
                tip.setAttribute('font-size', '10');
                tip.textContent = '💡 每个Span包含：SpanId, ParentSpanId, Timestamp, Duration';
                group.appendChild(tip);

                svg.appendChild(group);
                return group;
            }

            createServiceChain(svg) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');

                const services = [
                    { name: '用户', x: 50, y: 270 },
                    { name: '网关', x: 250, y: 270 },
                    { name: '订单', x: 450, y: 270 },
                    { name: '库存', x: 650, y: 270 },
                    { name: 'DB', x: 850, y: 270 }
                ];

                services.forEach(svc => {
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', svc.x);
                    rect.setAttribute('y', svc.y);
                    rect.setAttribute('width', '100');
                    rect.setAttribute('height', '60');
                    rect.setAttribute('rx', '6');
                    rect.setAttribute('fill', '#21262d');
                    rect.setAttribute('stroke', '#a371f7');
                    rect.setAttribute('stroke-width', '2');
                    group.appendChild(rect);

                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', svc.x + 50);
                    text.setAttribute('y', svc.y + 35);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#e6edf3');
                    text.setAttribute('font-size', '12');
                    text.textContent = svc.name;
                    group.appendChild(text);
                });

                svg.appendChild(group);
                return group;
            }

            createTraceIdBadge(svg, id, x, y) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '90');
                rect.setAttribute('height', '30');
                rect.setAttribute('rx', '4');
                rect.setAttribute('fill', '#a371f7');
                group.appendChild(rect);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', '45');
                text.setAttribute('y', '20');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#fff');
                text.setAttribute('font-size', '10');
                text.setAttribute('font-family', 'monospace');
                text.textContent = id;
                group.appendChild(text);

                svg.appendChild(group);
                return group;
            }

            createDataPacket(svg, text, x, y, color) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('r', '15');
                circle.setAttribute('fill', color);
                group.appendChild(circle);

                svg.appendChild(group);
                return group;
            }

            createSolutionCard(svg, name, x, y, color) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '320');
                rect.setAttribute('height', '250');
                rect.setAttribute('rx', '8');
                rect.setAttribute('fill', '#21262d');
                rect.setAttribute('stroke', color);
                rect.setAttribute('stroke-width', '2');
                group.appendChild(rect);

                const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                title.setAttribute('x', '160');
                title.setAttribute('y', '30');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('fill', color);
                title.setAttribute('font-size', '16');
                title.setAttribute('font-weight', 'bold');
                title.textContent = name;
                group.appendChild(title);

                const details = {
                    'Jaeger': ['Uber开源', 'CNCF毕业项目', '架构：Agent → Collector', '支持OpenTelemetry'],
                    'Zipkin': ['Twitter开源', '链路追踪鼻祖', '架构：Reporter → Collector', '轻量级易部署'],
                    'SkyWalking': ['国产开源', 'APM一体化平台', 'Java自动探针', '无侵入接入']
                };

                details[name].forEach((detail, i) => {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', '160');
                    text.setAttribute('y', 65 + i * 30);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#8b949e');
                    text.setAttribute('font-size', '11');
                    text.textContent = detail;
                    group.appendChild(text);
                });

                svg.appendChild(group);
                return group;
            }

            createWaterfallChart(svg, x, y) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '420');
                rect.setAttribute('height', '180');
                rect.setAttribute('rx', '8');
                rect.setAttribute('fill', '#21262d');
                rect.setAttribute('stroke', '#58a6ff');
                rect.setAttribute('stroke-width', '2');
                group.appendChild(rect);

                const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                title.setAttribute('x', '210');
                title.setAttribute('y', '25');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('fill', '#58a6ff');
                title.setAttribute('font-size', '14');
                title.setAttribute('font-weight', 'bold');
                title.textContent = '瀑布图：慢请求定位';
                group.appendChild(title);

                const spans = [
                    { name: '网关', duration: 50, delay: 0 },
                    { name: '订单', duration: 80, delay: 50 },
                    { name: '库存', duration: 250, delay: 130 },
                    { name: '支付', duration: 60, delay: 380 }
                ];

                spans.forEach((span, i) => {
                    const y = 50 + i * 30;

                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    label.setAttribute('x', '10');
                    label.setAttribute('y', y + 15);
                    label.setAttribute('fill', '#8b949e');
                    label.setAttribute('font-size', '11');
                    label.textContent = span.name;
                    group.appendChild(label);

                    const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    bar.setAttribute('x', 60 + span.delay);
                    bar.setAttribute('y', y);
                    bar.setAttribute('width', span.duration);
                    bar.setAttribute('height', '20');
                    bar.setAttribute('rx', '3');
                    bar.setAttribute('fill', span.name === '库存' ? '#f85149' : '#58a6ff');
                    if (span.name === '库存') {
                        bar.classList.add('slow-bar');
                    }
                    group.appendChild(bar);

                    const time = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    time.setAttribute('x', 65 + span.delay);
                    time.setAttribute('y', y + 14);
                    time.setAttribute('fill', '#fff');
                    time.setAttribute('font-size', '9');
                    time.textContent = `${span.duration}ms`;
                    group.appendChild(time);
                });

                svg.appendChild(group);
                return group;
            }

            createPerformanceAnalysis(svg, x, y) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '480');
                rect.setAttribute('height', '180');
                rect.setAttribute('rx', '8');
                rect.setAttribute('fill', '#21262d');
                rect.setAttribute('stroke', '#3fb950');
                rect.setAttribute('stroke-width', '2');
                group.appendChild(rect);

                const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                title.setAttribute('x', '240');
                title.setAttribute('y', '25');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('fill', '#3fb950');
                title.setAttribute('font-size', '14');
                title.setAttribute('font-weight', 'bold');
                title.textContent = '性能瓶颈分析';
                group.appendChild(title);

                const points = [
                    '发现问题：库存服务查询耗时250ms',
                    '定位原因：数据库索引缺失',
                    '解决方案：添加商品ID索引',
                    '优化效果：查询耗时降至25ms ⚡'
                ];

                points.forEach((point, i) => {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', '240');
                    text.setAttribute('y', 55 + i * 28);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', i === 3 ? '#3fb950' : '#8b949e');
                    text.setAttribute('font-size', '12');
                    text.textContent = point;
                    group.appendChild(text);
                });

                svg.appendChild(group);
                return group;
            }

            createSamplingStrategy(svg, x, y) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '450');
                rect.setAttribute('height', '130');
                rect.setAttribute('rx', '8');
                rect.setAttribute('fill', '#21262d');
                rect.setAttribute('stroke', '#d29922');
                rect.setAttribute('stroke-width', '2');
                group.appendChild(rect);

                const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                title.setAttribute('x', '225');
                title.setAttribute('y', '25');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('fill', '#d29922');
                title.setAttribute('font-size', '14');
                title.setAttribute('font-weight', 'bold');
                title.textContent = '采样策略建议';
                group.appendChild(title);

                const strategies = [
                    '生产环境：10%采样率（每10个请求记录1个）',
                    '开发环境：100%采样（完整记录）',
                    '只记录慢请求：如耗时 > 1秒'
                ];

                strategies.forEach((strategy, i) => {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', '225');
                    text.setAttribute('y', 50 + i * 25);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#8b949e');
                    text.setAttribute('font-size', '11');
                    text.textContent = strategy;
                    group.appendChild(text);
                });

                svg.appendChild(group);
                return group;
            }

            createBestPractices(svg, x, y) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('transform', `translate(${x}, ${y})`);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '480');
                rect.setAttribute('height', '130');
                rect.setAttribute('rx', '8');
                rect.setAttribute('fill', '#21262d');
                rect.setAttribute('stroke', '#a371f7');
                rect.setAttribute('stroke-width', '2');
                group.appendChild(rect);

                const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                title.setAttribute('x', '240');
                title.setAttribute('y', '25');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('fill', '#a371f7');
                title.setAttribute('font-size', '14');
                title.setAttribute('font-weight', 'bold');
                title.textContent = '最佳实践';
                group.appendChild(title);

                const practices = [
                    '1️⃣ 链路追踪 + 日志关联（日志中记录TraceId）',
                    '2️⃣ 链路追踪 + 监控告警（慢请求自动告警）',
                    '3️⃣ 定期分析Top 10慢请求'
                ];

                practices.forEach((practice, i) => {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', '240');
                    text.setAttribute('y', 50 + i * 25);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#8b949e');
                    text.setAttribute('font-size', '11');
                    text.textContent = practice;
                    group.appendChild(text);
                });

                svg.appendChild(group);
                return group;
            }

            // ============ 控制方法 ============

            nextStep() {
                const module = this.currentModule;
                const totalSteps = ModuleConfig[module].steps;

                if (this.currentStep[module] < totalSteps && !this.isAnimating) {
                    this.isAnimating = true;
                    this.currentStep[module]++;

                    const tl = this.timelines[module];
                    const targetLabel = `step${this.currentStep[module]}`;

                    tl.tweenTo(targetLabel, {
                        duration: 0.8 / this.speed,
                        ease: 'power2.inOut',
                        onComplete: () => {
                            tl.pause();
                            this.isAnimating = false;
                        }
                    });

                    this.showExplanation(module, this.currentStep[module]);
                    this.updateProgress();
                }
            }

            prevStep() {
                const module = this.currentModule;
                if (this.currentStep[module] > 0 && !this.isAnimating) {
                    this.isAnimating = true;
                    this.currentStep[module]--;

                    const tl = this.timelines[module];
                    const targetLabel = `step${this.currentStep[module]}`;

                    tl.tweenTo(targetLabel, {
                        duration: 0.8 / this.speed,
                        ease: 'power2.inOut',
                        onComplete: () => {
                            tl.pause();
                            this.isAnimating = false;
                        }
                    });

                    this.showExplanation(module, this.currentStep[module]);
                    this.updateProgress();
                }
            }

            reset() {
                const module = this.currentModule;
                this.currentStep[module] = 0;
                this.timelines[module].seek('step0');
                this.timelines[module].pause();
                this.showExplanation(module, 0);
                this.updateProgress();
            }

            setSpeed(speed) {
                this.speed = speed;
                this.timelines[this.currentModule].timeScale(speed);

                document.querySelectorAll('.speed-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (parseFloat(btn.dataset.speed) === speed) {
                        btn.classList.add('active');
                    }
                });
            }

            async autoPlay() {
                if (this.isAutoPlaying) return;

                this.isAutoPlaying = true;
                const module = this.currentModule;
                const totalSteps = ModuleConfig[module].steps;

                while (this.isAutoPlaying && this.currentStep[module] < totalSteps) {
                    this.nextStep();
                    await new Promise(resolve => setTimeout(resolve, 2000 / this.speed));
                }

                this.isAutoPlaying = false;
            }

            showExplanation(module, step) {
                const explanations = Explanations[module];
                if (explanations && explanations[step]) {
                    const explanationEl = document.getElementById(`explanation${module}`);
                    explanationEl.innerHTML = `
                        <div class="code-title">步骤说明</div>
                        <div class="code-content">${explanations[step]}</div>
                    `;
                    explanationEl.classList.add('visible');
                }
            }

            updateProgress() {
                const module = this.currentModule;
                const totalSteps = ModuleConfig[module].steps;
                const currentStep = this.currentStep[module];

                document.getElementById('stepCounter').textContent = `${currentStep} / ${totalSteps}`;

                const progress = (currentStep / totalSteps) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;

                const dotsContainer = document.getElementById('progressDots');
                dotsContainer.innerHTML = '';
                for (let i = 0; i <= totalSteps; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'progress-dot';
                    if (i < currentStep) dot.classList.add('completed');
                    if (i === currentStep) dot.classList.add('active');
                    dotsContainer.appendChild(dot);
                }

                document.getElementById('prevBtn').disabled = currentStep === 0;
                document.getElementById('nextBtn').disabled = currentStep === totalSteps;
            }
        }

        // 全局变量 - 在DOMContentLoaded之前声明
        let controller;

        // 全屏切换
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // 帮助信息
        function showHelp() {
            alert(`快捷键：
← 上一步
→ / 空格 下一步
R 重置
F 全屏
1-5 切换模块`);
        }

        // 初始化 - 在DOM加载完成后绑定事件
        document.addEventListener('DOMContentLoaded', () => {
            // 创建控制器实例
            controller = new AnimationController();

            // 绑定按钮事件
            document.getElementById('prevBtn').addEventListener('click', () => controller.prevStep());
            document.getElementById('nextBtn').addEventListener('click', () => controller.nextStep());
            document.getElementById('resetBtn').addEventListener('click', () => controller.reset());
            document.getElementById('autoPlayBtn').addEventListener('click', () => controller.autoPlay());

            // 绑定速度按钮事件
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const speed = parseFloat(btn.dataset.speed);
                    controller.setSpeed(speed);
                });
            });
        });
    </script>
</body>
</html>
