# 08 - 服务工厂模式+抽象基类 🏭

> **难度**: ⭐⭐⭐⭐ | **价值**: 🔥🔥🔥🔥 | **创新度**: ⭐⭐⭐⭐

---

## 📌 技术概述

### 核心设计模式

我们的系统采用了**抽象工厂模式**和**模板方法模式**的结合，通过定义统一的抽象基类，实现了：

| 设计目标 | 实现方式 |
|---------|---------|
| 接口统一 | `DataServiceBase` 抽象基类 |
| 多实现支持 | MockService / RealService |
| 易扩展性 | 继承基类即可新增服务 |
| 类型安全 | Python Type Hints |

### 设计模式结构

```
    抽象基类 (DataServiceBase)
           ↓
    ┌──────┴──────┐
    ↓             ↓
MockService  RealService
(模拟服务)    (真实服务)
```

---

## 🔍 技术原理

### 抽象基类定义

```python
from abc import ABC, abstractmethod

class DataServiceBase(ABC):
    """数据服务抽象基类"""

    def __init__(self):
        self.source_type: str = "base"

    @abstractmethod
    async def get_attractions(self, city, tags, limit) -> list:
        """抽象方法：子类必须实现"""
        pass

    @abstractmethod
    async def chat(self, message, session_id, context) -> dict:
        """抽象方法：子类必须实现"""
        pass
```

### 工厂模式实现

```python
class ServiceFactory:
    """服务工厂"""

    @staticmethod
    def create_service(source: str) -> DataServiceBase:
        """根据数据源创建对应的服务实例"""
        if source == "real":
            return RealService()
        else:
            return MockService()

# 使用
service = ServiceFactory.create_service("mock")
result = await service.get_attractions()
```

### 模板方法模式

```python
class DataServiceBase(ABC):
    """基类定义算法骨架"""

    async def get_dashboard_stats(self, time_range: str = "7d") -> dict:
        """模板方法：定义处理流程"""
        # 1. 获取基础数据
        base_data = await self._get_base_stats()

        # 2. 应用时间系数（子类可覆盖）
        time_factor = self._get_time_factor()

        # 3. 计算最终结果
        return self._calculate_stats(base_data, time_factor)

    @abstractmethod
    async def _get_base_stats(self) -> dict:
        """抽象方法：子类实现具体逻辑"""
        pass

    def _get_time_factor(self) -> float:
        """钩子方法：子类可覆盖"""
        return 1.0
```

---

## 💡 项目应用

### 代码位置

| 组件 | 文件位置 |
|-----|---------|
| **抽象基类** | [backend/app/services/base_service.py](../../backend/app/services/base_service.py) |
| **Mock服务** | [backend/app/services/mock_service.py](../../backend/app/services/mock_service.py) |
| **Real服务** | [backend/app/services/real_service.py](../../backend/app/services/real_service.py) |

### 实现细节

#### 1. 抽象基类定义完整接口

```python
# backend/app/services/base_service.py:9-141
class DataServiceBase(ABC):
    """数据服务抽象基类"""

    def __init__(self):
        self.source_type: str = "base"

    # ========== 游客端接口 ==========

    @abstractmethod
    async def get_attractions(
        self,
        city: Optional[str] = None,
        tags: Optional[list[str]] = None,
        limit: int = 20
    ) -> list:
        """获取景点列表"""
        pass

    @abstractmethod
    async def get_attraction_detail(self, attraction_id: str) -> Optional[dict]:
        """获取景点详情"""
        pass

    @abstractmethod
    async def plan_itinerary(
        self,
        days: int,
        city: str,
        preferences: list[str],
        budget: Optional[int] = None
    ) -> dict:
        """生成行程规划"""
        pass

    @abstractmethod
    async def chat(
        self,
        message: str,
        session_id: Optional[str] = None,
        context: Optional[dict] = None
    ) -> dict:
        """智能对话"""
        pass

    @abstractmethod
    async def get_realtime_info(self) -> dict:
        """获取实时信息（天气、客流等）"""
        pass

    # ========== 企业端接口 ==========

    @abstractmethod
    async def get_dashboard_stats(self, time_range: str = "7d") -> dict:
        """获取仪表板统计数据"""
        pass

    @abstractmethod
    async def get_customer_analytics(self, dimension: str = "all") -> dict:
        """获取客户分析数据"""
        pass

    # ========== 政府端接口 ==========

    @abstractmethod
    async def get_government_dashboard(self, region: str = "all") -> dict:
        """获取政府决策指挥舱数据"""
        pass

    @abstractmethod
    async def get_heatmap_data(self, level: str = "city", date: str = "today") -> dict:
        """获取热力图数据"""
        pass
```

#### 2. Mock服务完整实现

```python
# backend/app/services/mock_service.py:345-350
class MockDataService(DataServiceBase):
    """模拟数据服务实现"""

    def __init__(self):
        super().__init__()
        self.source_type = "mock"
        self.generator = MockDataGenerator()
        self.time_gen = TimeAwareGenerator()
        self.dynamic_gen = DynamicDataGenerator(self.time_gen)

    # 实现所有抽象方法
    async def get_attractions(self, city, tags, limit) -> list:
        """获取景点列表（带时间感知）"""
        attractions = ATTRACTIONS_DATA.copy()
        # ... 实现逻辑
        return attractions

    async def chat(self, message, session_id, context) -> dict:
        """智能对话（基于规则匹配）"""
        # ... 基于规则匹配的实现
        return response
```

#### 3. Real服务实现

```python
# backend/app/services/real_service.py:14-29
class RealDataService(DataServiceBase):
    """真实数据服务实现"""

    def __init__(self):
        super().__init__()
        self.source_type = "real"
        self._fallback = MockDataService()
        self._llm_client = None
        self._init_llm_client()

    async def chat(self, message, session_id, context) -> dict:
        """智能对话（使用真实LLM API）"""
        if self._llm_client is None:
            return await self._fallback.chat(message, session_id, context)

        # 调用真实LLM
        response = await self._llm_client.chat_with_suggestions(
            message=message,
            history=history
        )
        return response
```

### 核心代码示例

```python
# backend/app/services/base_service.py:9-26
from abc import ABC, abstractmethod
from typing import Optional

class DataServiceBase(ABC):
    """数据服务抽象基类"""

    def __init__(self):
        self.source_type: str = "base"

    @abstractmethod
    async def get_attractions(
        self,
        city: Optional[str] = None,
        tags: Optional[list[str]] = None,
        limit: int = 20
    ) -> list:
        """获取景点列表"""
        pass

    @abstractmethod
    async def chat(
        self,
        message: str,
        session_id: Optional[str] = None,
        context: Optional[dict] = None
    ) -> dict:
        """智能对话"""
        pass
```

---

## 🎯 演示话术

### 开场介绍（30秒）

```
"我们的后端采用了工厂模式和抽象基类的设计。

通过定义统一的接口规范，
让Mock服务和Real服务可以灵活切换，
同时保持接口的一致性。

这是面向对象设计思想的典型应用。"
```

### 深度讲解（2分钟）

```
"我们的设计包含三个层次：

第一层：抽象基类
我们定义了`DataServiceBase`抽象基类，
声明了所有需要实现的方法：
- get_attractions() - 获取景点列表
- chat() - 智能对话
- get_dashboard_stats() - 仪表板数据
...

这些方法都是抽象的，子类必须实现。

第二层：具体实现
- MockService: 基于规则生成模拟数据
- RealService: 接入LLM API

两个类都继承抽象基类，实现了相同的方法签名，
但内部实现完全不同。

第三层：工厂模式
通过简单的条件判断，
根据source参数创建对应的服务实例：
```
if source == "real":
    service = RealService()
else:
    service = MockService()
```

这种设计的优势：
① 接口统一：前端调用方式一致
② 易于扩展：新增服务只需继承基类
③ 类型安全：Python类型提示支持
④ 代码复用：公共逻辑在基类实现"
```

### 演示互动（1分钟）

```
（展示后端代码结构）

"各位评委请看我们的代码结构：

这是抽象基类`base_service.py`，
定义了20多个抽象方法，
覆盖了游客端、企业端、政府端的所有接口。

这是`mock_service.py`，
实现了基于规则的模拟数据生成。

这是`real_service.py`，
接入了真实的LLM API。

三个类通过继承关系组织在一起，
形成了清晰的架构层次。

当我们需要添加新的数据源时，
比如接入数据库服务，
只需要继承`DataServiceBase`基类，
实现这些抽象方法即可。

这就是设计模式带来的可扩展性。"
```

### 总结强调（30秒）

```
"工厂模式和抽象基类的价值：

① 接口统一：所有服务实现相同接口
② 易于扩展：新增服务只需继承基类
③ 代码清晰：职责分离，结构清晰
④ 符合SOLID原则：面向对象设计最佳实践

体现了我们扎实的软件工程功底！"
```

---

## 📊 对比优势

### 与传统方法对比

| 维度 | 传统方法 | 设计模式方法 |
|-----|---------|-------------|
| 代码复用 | 低（重复代码） | 高（基类复用） |
| 扩展性 | 差（修改现有代码） | 好（添加新类） |
| 维护性 | 低 | 高（职责清晰） |
| 类型安全 | 无 | 有（Type Hints） |

### 设计模式应用

| 设计模式 | 应用场景 | 优势 |
|---------|---------|------|
| **抽象工厂** | 服务实例创建 | 解耦创建逻辑 |
| **模板方法** | 算法骨架定义 | 复用算法流程 |
| **策略模式** | 不同数据源实现 | 算法可替换 |

---

## 🚀 应用场景/扩展性

### 应用场景

1. **数据源扩展**: 轻松添加新的数据源（数据库、缓存等）
2. **A/B测试**: 对比不同实现方案的效果
3. **降级策略**: Real服务失败时自动切换到Mock
4. **单元测试**: 使用Mock服务进行测试

### 扩展性示例

```python
# 添加新的数据库服务
class DatabaseService(DataServiceBase):
    """数据库服务实现"""

    def __init__(self, db_connection):
        super().__init__()
        self.source_type = "database"
        self.db = db_connection

    async def get_attractions(self, city, tags, limit):
        """从数据库查询景点"""
        query = "SELECT * FROM attractions WHERE city = $1"
        results = await self.db.fetch(query, city)
        return results

    # ... 实现其他抽象方法

# 使用
service = DatabaseService(pg_connection)
result = await service.get_attractions("太原")
```

---

## 📈 类图结构

```
┌─────────────────────────────────────────────────────┐
│                  DataServiceBase                    │
│  <<abstract>>                                      │
│  + source_type: str                                │
│  + get_attractions(): AbstractMethod               │
│  + chat(): AbstractMethod                          │
│  + get_dashboard_stats(): AbstractMethod           │
│  + ...                                             │
└─────────────────────────────────────────────────────┘
           △                           △
    ┌──────────┴──────────┐         ┌──────────┐
    ↓                     ↓         ↓          │
┌─────────────┐    ┌─────────────┐              │
│ MockService │    │RealService │              │
├─────────────┤    ├─────────────┤              │
│+ source_type│    │+ source_type│              │
│+ get_attr...│    │+ _fallback  │              │
│+ chat()     │    │+ _llm_client│              │
└─────────────┘    └─────────────┘              │
                                                 │
                                    ┌──────────────┘
                                    ↓
                            ┌─────────────┐
                            │DatabaseSvc  │
                            │(future)     │
                            └─────────────┘
```

---

## 🏆 总结

### 核心价值

1. **设计规范性**: ⭐⭐⭐⭐⭐
   - 遵循SOLID原则，面向对象设计

2. **可扩展性**: ⭐⭐⭐⭐⭐
   - 新增服务无需修改现有代码

3. **可维护性**: ⭐⭐⭐⭐⭐
   - 职责清晰，代码结构化

### 演示建议

- **最佳展示位置**: 后端架构讲解
- **演示时长**: 1-2分钟
- **关键话术**: "抽象基类+工厂模式"
- **视觉冲击**: 类图 + 代码结构

---

**文档版本**: v1.0
**最后更新**: 2026-01-02
**作者**: 山西文旅智能体团队
