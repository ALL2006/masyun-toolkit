# 37 - å•ä¾‹æ¨¡å¼ ğŸ”

> **éš¾åº¦**: â­â­â­ | **ä»·å€¼**: ğŸ”¥ğŸ”¥ğŸ”¥ | **åˆ›æ–°åº¦**: â­â­â­ |

---

## ğŸ“Œ æŠ€æœ¯æ¦‚è¿°

### æ ¸å¿ƒæ¦‚å¿µ/é—®é¢˜

å•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œå®ƒä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹ã€‚åœ¨å±±è¥¿æ–‡æ—…æ™ºèƒ½ä½“é¡¹ç›®ä¸­ï¼Œä¼šè¯ç®¡ç†å™¨ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿æ•´ä¸ªåº”ç”¨å…±äº«åŒä¸€ä¸ªä¼šè¯ç®¡ç†å™¨å®ä¾‹ï¼Œé¿å…èµ„æºæµªè´¹å’Œæ•°æ®ä¸ä¸€è‡´ã€‚

### æŠ€æœ¯æˆæœ/æ•°æ®

| æŒ‡æ ‡ | æ•°æ® | è¯´æ˜ |
|------|------|------|
| å•ä¾‹ç±» | 1ä¸ª | SessionManager |
| å…¨å±€è®¿é—® | get_session_manager() | ç»Ÿä¸€è·å–å‡½æ•° |
| ä¼šè¯å®¹é‡ | 1000+ | æ”¯æŒå¤§é‡å¹¶å‘ |
| å†…å­˜å ç”¨ | æœ€å° | å•ä¾‹èŠ‚çœå†…å­˜ |

---

## ğŸ” æŠ€æœ¯åŸç†

### æ ¸å¿ƒåŸç†

å•ä¾‹æ¨¡å¼é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **ç§æœ‰é™æ€å˜é‡**ï¼šå­˜å‚¨å”¯ä¸€å®ä¾‹
2. **å…¨å±€è®¿é—®å‡½æ•°**ï¼šget_session_manager()
3. **å»¶è¿Ÿåˆå§‹åŒ–**ï¼šé¦–æ¬¡ä½¿ç”¨æ—¶åˆ›å»º
4. **çº¿ç¨‹å®‰å…¨**ï¼šç¡®ä¿å¹¶å‘å®‰å…¨

### æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               å•ä¾‹æ¨¡å¼æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  å…¨å±€å˜é‡ (_global_session_manager)                   â”‚
â”‚       â”‚                                             â”‚
â”‚       â””â”€â”€ åˆå§‹å€¼: None                              â”‚
â”‚                                                     â”‚
â”‚  å…¨å±€è®¿é—®å‡½æ•°                                        â”‚
â”‚       â”‚                                             â”‚
â”‚   def get_session_manager() -> SessionManager:      â”‚
â”‚       â”‚                                             â”‚
â”‚       â”œâ”€â”€ æ£€æŸ¥å…¨å±€å˜é‡æ˜¯å¦ä¸ºç©º                        â”‚
â”‚       â”œâ”€â”€ ä¸ºç©º: åˆ›å»ºæ–°å®ä¾‹å¹¶å­˜å…¥å…¨å±€å˜é‡              â”‚
â”‚       â”œâ”€â”€ ä¸ä¸ºç©º: è¿”å›å·²æœ‰å®ä¾‹                      â”‚
â”‚       â””â”€â”€ è¿”å›å”¯ä¸€å®ä¾‹                              â”‚
â”‚                                                     â”‚
â”‚  ä½¿ç”¨ç¤ºä¾‹                                            â”‚
â”‚       â”‚                                             â”‚
â”‚   from app.services.session_manager import get...    â”‚
â”‚   session_mgr = get_session_manager()               â”‚
â”‚   session_mgr.add_message(...)                      â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¡ é¡¹ç›®åº”ç”¨

### ä»£ç ä½ç½®

**æ ¸å¿ƒæ–‡ä»¶ï¼š**
- ä¼šè¯ç®¡ç†å™¨ï¼š[backend/app/services/session_manager.py](../../backend/app/services/session_manager.py#L224-L241)

### å®ç°ç»†èŠ‚

```python
# backend/app/services/session_manager.py:224-241

# å…¨å±€ä¼šè¯ç®¡ç†å™¨å®ä¾‹
_global_session_manager: Optional[SessionManager] = None


def get_session_manager() -> SessionManager:
    """è·å–å…¨å±€ä¼šè¯ç®¡ç†å™¨å®ä¾‹

    è¿™æ˜¯å•ä¾‹æ¨¡å¼çš„å®ç°ï¼š
    - ä½¿ç”¨æ¨¡å—çº§å˜é‡å­˜å‚¨å”¯ä¸€å®ä¾‹
    - é€šè¿‡å‡½æ•°æ§åˆ¶è®¿é—®
    - å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆé¦–æ¬¡ä½¿ç”¨æ—¶åˆ›å»ºï¼‰
    """
    global _global_session_manager
    if _global_session_manager is None:
        _global_session_manager = SessionManager()
    return _global_session_manager
```

### æ ¸å¿ƒä»£ç ç¤ºä¾‹

```python
"""
å•ä¾‹æ¨¡å¼å®Œæ•´ç¤ºä¾‹
"""

# æ–¹å¼1: æ¨¡å—çº§å•ä¾‹ï¼ˆPythonæ¨èï¼‰
# session_manager.py

class SessionManager:
    """ä¼šè¯ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰"""
    _instance = None

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance

    def __init__(self):
        if hasattr(self, '_initialized'):
            return
        # åˆå§‹åŒ–ä»£ç 
        self.sessions = {}
        self.max_sessions = 1000
        self._initialized = True


# å…¨å±€è®¿é—®å‡½æ•°
def get_session_manager() -> SessionManager:
    """è·å–å…¨å±€ä¼šè¯ç®¡ç†å™¨å®ä¾‹"""
    if SessionManager._instance is None:
        SessionManager()
    return SessionManager._instance


# ä½¿ç”¨ç¤ºä¾‹
mgr1 = get_session_manager()
mgr2 = get_session_manager()
print(mgr1 is mgr2)  # Trueï¼ŒåŒä¸€ä¸ªå®ä¾‹


# æ–¹å¼2: åŸºäºè£…é¥°å™¨çš„å•ä¾‹
def singleton(cls):
    """å•ä¾‹è£…é¥°å™¨"""
    instances = {}

    def get_instance(*args, **kwargs):
        if cls not in instances:
            instances[cls] = cls(*args, **kwargs)
        return instances[cls]

    return get_instance


@singleton
class DatabaseConnection:
    """æ•°æ®åº“è¿æ¥ï¼ˆå•ä¾‹ï¼‰"""
    def __init__(self):
        self.connection = connect_to_database()


# ä½¿ç”¨
db1 = DatabaseConnection()
db2 = DatabaseConnection()
print(db1 is db2)  # True
```

---

## ğŸ¯ æ¼”ç¤ºè¯æœ¯

### å¼€åœºä»‹ç»ï¼ˆ30ç§’ï¼‰

```
"æˆ‘ä»¬ä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†å…¨å±€ä¼šè¯ï¼Œ
ç¡®ä¿æ•´ä¸ªåº”ç”¨å…±äº«åŒä¸€ä¸ªä¼šè¯ç®¡ç†å™¨å®ä¾‹ï¼Œ
é¿å…èµ„æºæµªè´¹å’Œæ•°æ®ä¸ä¸€è‡´ã€‚"
```

### æ·±åº¦è®²è§£ï¼ˆ2åˆ†é’Ÿï¼‰

```
"å•ä¾‹æ¨¡å¼çš„æ ¸å¿ƒæ˜¯ç¡®ä¿å”¯ä¸€å®ä¾‹ã€‚

åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼š
1. ä½¿ç”¨æ¨¡å—çº§å˜é‡å­˜å‚¨å®ä¾‹
2. é€šè¿‡get_session_manager()å‡½æ•°è®¿é—®
3. é¦–æ¬¡è°ƒç”¨æ—¶åˆ›å»ºå®ä¾‹
4. åç»­è°ƒç”¨è¿”å›åŒä¸€å®ä¾‹

è¿™ç§è®¾è®¡çš„å¥½å¤„ï¼š
- å†…å­˜å ç”¨æœ€å°
- å…¨å±€çŠ¶æ€ä¸€è‡´
- å¹¶å‘å®‰å…¨è€ƒè™‘

æ¯”å¦‚æ‰€æœ‰APIç«¯ç‚¹éœ€è¦è®¿é—®ä¼šè¯ç®¡ç†å™¨æ—¶ï¼Œ
éƒ½è°ƒç”¨get_session_manager()ï¼Œ
å¾—åˆ°çš„æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œ
ç¡®ä¿ä¼šè¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚"
```

---

## ğŸ“Š å¯¹æ¯”ä¼˜åŠ¿

| ç»´åº¦ | æ— å•ä¾‹ | å•ä¾‹æ¨¡å¼ |
|-----|-------|---------|
| å†…å­˜å ç”¨ | é«˜ | ä½ |
| çŠ¶æ€ä¸€è‡´æ€§ | ä½ | é«˜ |
| èµ„æºç«äº‰ | å¯èƒ½ | é¿å… |

---

## ğŸ† æ€»ç»“

1. **èµ„æºæ•ˆç‡**: â­â­â­â­â­
2. **çŠ¶æ€ä¸€è‡´**: â­â­â­â­â­
3. **å®ç°ç®€å•**: â­â­â­â­â­

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-01-02
**ä½œè€…**: å±±è¥¿æ–‡æ—…æ™ºèƒ½ä½“å›¢é˜Ÿ
