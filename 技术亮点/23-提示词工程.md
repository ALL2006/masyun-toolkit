# 23 - 提示词工程 🎯

> **难度**: ⭐⭐⭐⭐ | **价值**: 🔥🔥🔥🔥🔥 | **创新度**: ⭐⭐⭐⭐⭐

---

## 📌 技术概述

### 核心概念/问题背景

提示词工程（Prompt Engineering）是指通过精心设计和优化输入给大语言模型的提示词，以获得更准确、更有用的输出。在智能体应用中，提示词的质量直接决定了AI的回答效果。

山西文旅智能体针对山西旅游场景，设计了专门的系统提示词，确保AI能够准确回答山西景点、美食、住宿等问题，并提供专业的旅游建议。

### 技术成果/数据

| 指标 | 数据 | 说明 |
|------|------|------|
| 提示词版本 | v2.0 | 多轮迭代优化 |
| 核心指令数 | 4条 | 角色定位、职责、要求、内容 |
| 景点覆盖 | 6大核心景点 | 平遥、五台山、云冈等 |
| 特色条目 | 10+ | 美食、景点、历史文化 |

---

## 🔍 技术原理

### 核心原理/算法设计

提示词工程基于以下核心原则：

1. **角色定位（Role Definition）**
   - 明确AI的身份和定位
   - 设定专业领域范围

2. **任务描述（Task Description）**
   - 清晰说明AI需要完成的任务
   - 定义输出格式和要求

3. **上下文信息（Context Information）**
   - 提供必要的背景知识
   - 包含领域专业信息

4. **输出规范（Output Specification）**
   - 规定回答的风格和格式
   - 设定质量标准

### 技术方案/架构

```
┌─────────────────────────────────────────────────────┐
│               提示词工程架构                          │
├─────────────────────────────────────────────────────┤
│                                                     │
│  系统提示词 (System Prompt)                         │
│       │                                             │
│       ├── 1. 角色定位                               │
│       │    "你是山西文旅智能助手"                   │
│       │                                             │
│       ├── 2. 主要职责                               │
│       │    - 回答景点、美食、住宿问题               │
│       │    - 提供行程规划建议                       │
│       │    - 介绍历史文化                           │
│       │                                             │
│       ├── 3. 回答要求                               │
│       │    - 友好热情，专业准确                     │
│       │    - 信息详实，有针对性                     │
│       │    - 主动推荐相关内容                       │
│       │                                             │
│       └── 4. 核心内容                               │
│            - 主要景点列表                           │
│            - 特色美食列表                           │
│            - 历史文化背景                           │
│       │                                             │
│       ▼                                             │
│  用户消息 (User Message)                            │
│       │                                             │
│       ▼                                             │
│  对话历史 (Conversation History)                    │
│       │                                             │
│       ▼                                             │
│  组合发送给 LLM                                     │
│       │                                             │
│       ▼                                             │
│  AI 回复                                           │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 💡 项目应用

### 代码位置

**核心文件：**
- LLM客户端：[backend/app/integrations/llm_client.py](../../backend/app/integrations/llm_client.py#L245-263)

### 实现细节

#### 1. 系统提示词定义

在 LLM 客户端中定义默认系统提示词：

```python
# backend/app/integrations/llm_client.py:245-263
def _get_default_system_prompt(self) -> str:
    """获取默认系统提示词"""
    return """你是山西文旅智能助手，专门为游客提供山西旅游咨询服务。

你的主要职责：
1. 回答关于山西景点、美食、住宿、交通等问题
2. 提供行程规划建议
3. 介绍山西的历史文化和风土人情
4. 提供实用的旅游建议和注意事项

回答要求：
- 友好热情，专业准确
- 信息详实，有针对性
- 可以主动推荐相关内容
- 适当表达情感，让游客感受到山西的魅力

山西主要景点：平遥古城、五台山、云冈石窟、晋祠、乔家大院、北岳恒山等。
山西特色美食：刀削面、平遥牛肉、太谷饼、莜面栲栳栳、老陈醋等。
"""
```

#### 2. 构建消息列表

在调用LLM时组合系统提示词和用户消息：

```python
# backend/app/integrations/llm_client.py:95-163
async def chat(
    self,
    message: str,
    system_prompt: Optional[str] = None,
    history: Optional[list[dict]] = None,
    temperature: float = 0.7,
    max_tokens: int = 2000
) -> dict:
    """发送对话请求"""

    # 构建消息列表
    messages = []

    # 添加系统提示词
    if system_prompt:
        messages.append({"role": "system", "content": system_prompt})
    else:
        messages.append({
            "role": "system",
            "content": self._get_default_system_prompt()
        })

    # 添加历史记录
    if history:
        messages.extend(history)

    # 添加当前消息
    messages.append({"role": "user", "content": message})

    # 调用 LLM API
    response = await self._send_request(
        messages=messages,
        temperature=temperature,
        max_tokens=max_tokens
    )

    return response
```

#### 3. 带历史记录的对话

支持多轮对话，保持上下文连贯：

```python
# backend/app/services/real_service.py:99-148
async def chat(
    self,
    message: str,
    session_id: Optional[str] = None,
    context: Optional[dict] = None
) -> dict:
    """智能对话（使用真实LLM API，支持会话历史）"""

    try:
        # 获取会话历史
        history = None
        if session_id:
            from app.services.session_manager import get_session_manager
            session_mgr = get_session_manager()
            history = session_mgr.get_history(session_id)

        # 调用真实LLM API（包含历史）
        response = await self._llm_client.chat_with_suggestions(
            message=message,
            history=history  # 传入历史记录
        )

        # 保存对话到会话历史
        if session_id:
            from app.services.session_manager import get_session_manager
            session_mgr = get_session_manager()
            session_mgr.add_message(session_id, "user", message)
            session_mgr.add_message(session_id, "assistant", response.get("reply", ""))

        return response

    except Exception as e:
        # LLM调用失败，fallback到mock服务
        logger.error(f"LLM call failed: {str(e)}")
        return await self._fallback.chat(message, session_id, context)
```

### 核心代码示例

```python
"""
提示词工程完整示例
展示如何设计和优化提示词
"""

class PromptTemplate:
    """提示词模板类"""

    # 基础提示词模板
    BASE_TEMPLATE = """你是{role}，专门为{target}提供{service}。

你的主要职责：
{responsibilities}

回答要求：
{requirements}

核心知识：
{knowledge}
"""

    # 山西文旅智能体提示词
    SHANXI_TOURISM_PROMPT = {
        "role": "山西文旅智能助手",
        "target": "游客",
        "service": "山西旅游咨询服务",
        "responsibilities": """
1. 回答关于山西景点、美食、住宿、交通等问题
2. 提供行程规划建议
3. 介绍山西的历史文化和风土人情
4. 提供实用的旅游建议和注意事项
        """.strip(),
        "requirements": """
- 友好热情，专业准确
- 信息详实，有针对性
- 可以主动推荐相关内容
- 适当表达情感，让游客感受到山西的魅力
        """.strip(),
        "knowledge": """
山西主要景点：平遥古城、五台山、云冈石窟、晋祠、乔家大院、北岳恒山等。
山西特色美食：刀削面、平遥牛肉、太谷饼、莜面栲栳栳、老陈醋等。
        """.strip()
    }

    @classmethod
    def build_prompt(cls, template: dict) -> str:
        """构建完整提示词"""
        return cls.BASE_TEMPLATE.format(**template)

    @classmethod
    def get_tourism_prompt(cls) -> str:
        """获取旅游助手提示词"""
        return cls.build_prompt(cls.SHANXI_TOURISM_PROMPT)

    @classmethod
    def build_contextual_prompt(
        cls,
        base_prompt: str,
        user_context: dict
    ) -> str:
        """构建带上下文的提示词"""
        additions = []

        # 添加季节上下文
        if "season" in user_context:
            season = user_context["season"]
            additions.append(f"当前季节：{season}")

        # 添加位置上下文
        if "location" in user_context:
            location = user_context["location"]
            additions.append(f"用户当前位置：{location}")

        # 添加偏好上下文
        if "preferences" in user_context:
            prefs = ", ".join(user_context["preferences"])
            additions.append(f"用户偏好：{prefs}")

        if additions:
            context_str = "\n".join(additions)
            return f"{base_prompt}\n\n当前上下文：\n{context_str}"

        return base_prompt

# 使用示例
prompt = PromptTemplate.get_tourism_prompt()

# 带上下文的提示词
contextual_prompt = PromptTemplate.build_contextual_prompt(
    prompt,
    {
        "season": "夏季",
        "location": "太原",
        "preferences": ["古建筑", "美食"]
    }
)
```

---

## 🎯 演示话术

### 开场介绍（30秒）

```
"各位评委老师，我们精心设计了山西文旅智能体的提示词。

提示词是决定AI回答质量的关键，
我们的提示词经过多轮迭代优化，
确保AI能准确、专业地回答山西旅游相关问题。"
```

### 深度讲解（2分钟）

```
"一个好的提示词需要包含四个核心要素：

**第一是角色定位**。
我们明确告诉AI：'你是山西文旅智能助手'，
这样AI就知道自己的身份和服务范围。

**第二是职责描述**。
我们列出了AI的4项主要职责：
回答景点美食问题、提供行程规划、介绍历史文化、给出实用建议。
这样AI就知道应该做什么。

**第三是回答要求**。
我们要求AI：友好热情、专业准确、主动推荐、表达情感。
这确保了回答的质量和风格。

**第四是核心知识**。
我们在提示词中直接嵌入了山西主要景点和特色美食，
确保AI有足够的背景知识回答问题。

此外，我们还支持上下文感知。
比如知道用户在夏天、在太原、喜欢古建筑，
AI就能给出更个性化的建议。

这种精心设计的提示词，
让我们的智能助手比通用AI更专业、更懂山西。"
```

### 演示互动（1分钟）

```
[操作演示]

1. 展示基础对话效果
   "大家请看，当用户问'平遥古城怎么样'时，
    AI会给出详细、专业的回答，
    包括景点介绍、游览建议等。"

2. 展示专业知识
   "当用户询问山西美食时，
    AI能准确列出刀削面、平遥牛肉、太谷饼等特色，
    这都是我们在提示词中提供的核心知识。"

3. 展示情感化表达
   "AI的回答不仅专业，还富有情感，
    比如'让游客感受到山西的魅力'，
    这提升了用户体验。"
```

### 总结强调（30秒）

```
"通过提示词工程，我们实现了：
- AI回答的专业性
- 知识的准确性
- 服务的友好性
- 建议的针对性

这充分体现了我们对大语言模型的深度理解和应用。"
```

---

## 📊 对比优势

### 与通用LLM对比

| 维度 | 通用LLM | 我们的提示词工程 |
|-----|---------|----------------|
| 领域专业性 | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| 回答准确性 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 知识覆盖 | 泛而浅 | 精而深 |
| 用户体验 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 开发成本 | 高 | 低 |

### 提示词版本演进

| 版本 | 主要改进 | 效果提升 |
|------|---------|---------|
| v1.0 | 基础角色定义 | ⭐⭐⭐ |
| v1.5 | 添加核心知识 | ⭐⭐⭐⭐ |
| v2.0 | 优化回答要求 | ⭐⭐⭐⭐⭐ |

---

## 🚀 应用场景/扩展性

### 应用场景

1. **垂直领域智能体**
   - 旅游、金融、医疗等专业领域
   - 需要专业知识的场景

2. **企业知识库问答**
   - 基于企业文档构建提示词
   - 智能客服、内部助手

3. **个性化推荐**
   - 结合用户偏好动态调整提示词
   - 提供定制化服务

### 扩展性

提示词工程可扩展到：
- **Few-shot Learning**：提供示例提升效果
- **Chain of Thought**：引导AI逐步推理
- **动态提示词**：根据对话上下文调整
- **A/B测试**：优化提示词效果

---

## 🏆 总结

### 核心价值

1. **专业性**: ⭐⭐⭐⭐⭐
   - 领域知识准确

2. **可控性**: ⭐⭐⭐⭐⭐
   - 输出格式规范

3. **成本效益**: ⭐⭐⭐⭐⭐
   - 无需训练，直接使用

4. **可维护性**: ⭐⭐⭐⭐⭐
   - 易于迭代优化

### 演示建议

- **最佳展示位置**: AI对话效果展示
- **演示时长**: 1.5 分钟
- **关键话术**: "精心设计，专业回答"
- **视觉冲击**: 对比通用AI和专业智能体的回答差异

---

**文档版本**: v1.0
**最后更新**: 2026-01-02
**作者**: 山西文旅智能体团队
