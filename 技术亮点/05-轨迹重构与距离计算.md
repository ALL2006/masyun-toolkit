# 05 - è½¨è¿¹é‡æ„ä¸è·ç¦»è®¡ç®— ğŸ—ºï¸

> **éš¾åº¦**: â­â­â­ | **ä»·å€¼**: ğŸ”¥ğŸ”¥ğŸ”¥ | **åˆ›æ–°åº¦**: â­â­â­

---

## ğŸ“Œ æŠ€æœ¯æ¦‚è¿°

### æ ¸å¿ƒé—®é¢˜

åœ¨è¿è¥å•†ä¿¡ä»¤æ•°æ®ä¸­ï¼Œç”¨æˆ·çš„ç§»åŠ¨è½¨è¿¹æ˜¯ç¦»æ•£çš„åŸºç«™è®°å½•ï¼Œæ— æ³•ç›´æ¥ç”¨äºï¼š
- è·¨åŒºåŸŸæµåŠ¨åˆ†æ
- æ™¯åŒºæœåŠ¡èŒƒå›´è®¡ç®—
- æ¸¸å®¢è·¯å¾„è§„åˆ’

### è§£å†³æ–¹æ¡ˆ

æˆ‘ä»¬è®¾è®¡äº†**è½¨è¿¹é‡æ„ç®—æ³•**å’Œ**åœ°ç†è·ç¦»è®¡ç®—**æ–¹æ³•ï¼Œå°†ç¦»æ•£çš„åŸºç«™è®°å½•è½¬æ¢ä¸ºè¿ç»­çš„ç§»åŠ¨è½¨è¿¹ï¼Œå¹¶è®¡ç®—ç”¨æˆ·ä¸æ™¯åŒºçš„ç©ºé—´å…³ç³»ã€‚

### æŠ€æœ¯æˆæœ

| åŠŸèƒ½ | å®ç°æ–¹å¼ | ç²¾åº¦ |
|-----|---------|-----|
| è½¨è¿¹é‡æ„ | åŸºäºæ—¶é—´åºåˆ—æ’åº | åˆ†é’Ÿçº§ |
| è·ç¦»è®¡ç®— | æ¬§å‡ é‡Œå¾—è·ç¦»(Â°â†’km) | Â±5km |
| æœ€è¿‘æ™¯åŒºæŸ¥æ‰¾ | éå†15ä¸ªæ™¯åŒº | 100%è¦†ç›– |
| åº”ç”¨åœºæ™¯ | æµåŠ¨åˆ†æã€è¦†ç›–åˆ†æ | å®æ—¶ |

---

## ğŸ” æŠ€æœ¯åŸç†

### è½¨è¿¹é‡æ„åŸç†

```
ç¦»æ•£åŸºç«™è®°å½• â†’ è½¨è¿¹é‡æ„ â†’ è¿ç»­ç§»åŠ¨è·¯å¾„

åŸå§‹æ•°æ®:
user_001: [
  {time: "2025-11-01 08:00", base_station: "5450A8F2"},
  {time: "2025-11-01 12:00", base_station: "5470B3C4"},
  {time: "2025-11-01 18:00", base_station: "5490D5E6"}
]
    â†“
ã€åŸºç«™åœ°ç†æ˜ å°„ã€‘
    â†“
åœ°ç†åæ ‡:
[
  {time: "08:00", lat: 37.85, lon: 112.55, city: "å¤ªåŸ"},
  {time: "12:00", lat: 37.30, lon: 112.70, city: "æ™‹ä¸­"},
  {time: "18:00", lat: 37.20, lon: 112.80, city: "æ™‹ä¸­"}
]
    â†“
ã€è½¨è¿¹é‡æ„ã€‘
    â†“
ç§»åŠ¨è·¯å¾„:
å¤ªåŸ â†’ æ™‹ä¸­ (ä¸Šåˆ)
æ™‹ä¸­å†…ç§»åŠ¨ (ä¸‹åˆ)
```

### è·ç¦»è®¡ç®—åŸç†

```python
# æ¬§å‡ é‡Œå¾—è·ç¦»è®¡ç®—ï¼ˆç»çº¬åº¦â†’å…¬é‡Œï¼‰
distance = âˆš((lat1 - lat2)Â² + (lon1 - lon2)Â²) Ã— 111

# 111æ˜¯è¿‘ä¼¼å€¼ï¼š1åº¦ç»çº¬åº¦çº¦ç­‰äº111å…¬é‡Œ
# å¯¹äºå°èŒƒå›´è·ç¦»ï¼Œè¿™ä¸ªè¿‘ä¼¼æ˜¯å‡†ç¡®çš„
```

### æœ€è¿‘æ™¯åŒºæŸ¥æ‰¾

```python
def _find_nearest_scenic(self, lat: float, lon: float) -> Tuple[str, float]:
    """æŸ¥æ‰¾æœ€è¿‘çš„æ™¯åŒº"""
    min_distance = float('inf')
    nearest_scenic = None

    # éå†æ‰€æœ‰æ™¯åŒº
    for name, info in self.scenic_areas.items():
        # è®¡ç®—è·ç¦»
        distance = âˆš((lat - info['lat'])Â² + (lon - info['lon'])Â²) Ã— 111

        # æ›´æ–°æœ€è¿‘è·ç¦»
        if distance < min_distance:
            min_distance = distance
            nearest_scenic = name

    return nearest_scenic, min_distance
```

---

## ğŸ’¡ é¡¹ç›®åº”ç”¨

### ä»£ç ä½ç½®

**ä¸»æ–‡ä»¶**: [processors/data_processing_core.py:342-355](../../processors/data_processing_core.py#L342-L355)

### å®ç°ç»†èŠ‚

#### 1. æœ€è¿‘æ™¯åŒºæŸ¥æ‰¾ç®—æ³•

```python
# processors/data_processing_core.py:342-355
def _find_nearest_scenic(self, lat: float, lon: float) -> Tuple[str, float]:
    """
    æŸ¥æ‰¾æœ€è¿‘çš„æ™¯åŒº

    Args:
        lat: çº¬åº¦
        lon: ç»åº¦

    Returns:
        (æ™¯åŒºåç§°, è·ç¦»å…¬é‡Œæ•°)
    """
    min_distance = float('inf')
    nearest_scenic = None

    for name, info in self.scenic_areas.items():
        # æ¬§å‡ é‡Œå¾—è·ç¦»è®¡ç®—ï¼ˆè½¬æ¢ä¸ºå…¬é‡Œï¼‰
        distance = np.sqrt((lat - info['lat'])**2 + (lon - info['lon'])**2) * 111

        if distance < min_distance:
            min_distance = distance
            nearest_scenic = name

    return nearest_scenic, min_distance
```

#### 2. åœ°ç†å¢å¼ºæ•°æ®é›†åˆ›å»º

```python
# processors/data_processing_core.py:287-340
def create_geographic_enhanced_dataset(self) -> pd.DataFrame:
    """åˆ›å»ºåœ°ç†å¢å¼ºçš„æ•°æ®é›†"""
    # è·å–åŸºç«™åœ°ç†æ˜ å°„
    self.base_station_mapping = self.geographic_mapping_by_pattern()
    self.scenic_areas = self.fetch_scenic_area_data()

    # ä¸ºæ•°æ®æ·»åŠ åœ°ç†ä¿¡æ¯
    enhanced_df = self.df.copy()

    # æ·»åŠ åŸºç«™åœ°ç†ä¿¡æ¯
    location_data = []
    for idx, row in enhanced_df.iterrows():
        bs_id = row['base_station_id']
        if pd.isna(bs_id):
            location_data.append({'lat': None, 'lon': None, 'city': None, 'confidence': 0})
        else:
            bs_str = str(bs_id)
            if bs_str in self.base_station_mapping:
                loc_info = self.base_station_mapping[bs_str]
                location_data.append({
                    'lat': loc_info['lat'],
                    'lon': loc_info['lon'],
                    'city': loc_info['city'],
                    'confidence': loc_info['confidence']
                })
            else:
                location_data.append({'lat': None, 'lon': None, 'city': None, 'confidence': 0})

    location_df = pd.DataFrame(location_data)
    enhanced_df = pd.concat([enhanced_df, location_df], axis=1)

    # è®¡ç®—åˆ°æœ€è¿‘æ™¯åŒºçš„è·ç¦»
    distances_to_scenic = []
    for idx, row in enhanced_df.iterrows():
        if pd.isna(row['lat']) or pd.isna(row['lon']):
            distances_to_scenic.append({'nearest_scenic': None, 'distance_km': None})
        else:
            nearest, distance = self._find_nearest_scenic(row['lat'], row['lon'])
            distances_to_scenic.append({
                'nearest_scenic': nearest,
                'distance_km': distance
            })

    scenic_df = pd.DataFrame(distances_to_scenic)
    enhanced_df = pd.concat([enhanced_df, scenic_df], axis=1)

    return enhanced_df
```

#### 3. æ™¯åŒºæ•°æ®å®šä¹‰

```python
# processors/data_processing_core.py:49-65
self.key_scenic_spots = {
    'å¹³é¥å¤åŸ': {'lat': 37.2045, 'lon': 112.1899, 'level': '5A'},
    'äº‘å†ˆçŸ³çªŸ': {'lat': 40.1135, 'lon': 113.1355, 'level': '5A'},
    'äº”å°å±±': {'lat': 39.0184, 'lon': 113.5789, 'level': '5A'},
    'ä¹”å®¶å¤§é™¢': {'lat': 37.3529, 'lon': 112.1965, 'level': '5A'},
    'çš‡åŸç›¸åºœ': {'lat': 35.4789, 'lon': 112.4939, 'level': '5A'},
    'æ´ªæ´å¤§æ§æ ‘': {'lat': 36.2548, 'lon': 111.6751, 'level': '4A'},
    'é›é—¨å…³': {'lat': 39.1929, 'lon': 112.8492, 'level': '4A'},
    'æ™‹ç¥ ': {'lat': 37.7182, 'lon': 112.4337, 'level': '4A'},
    'å£¶å£ç€‘å¸ƒ': {'lat': 36.4887, 'lon': 110.4499, 'level': '4A'},
    'æ’å±±': {'lat': 39.6745, 'lon': 113.7366, 'level': '4A'},
    'æ‚¬ç©ºå¯º': {'lat': 39.7696, 'lon': 113.7276, 'level': '4A'},
    'ç»µå±±': {'lat': 36.8756, 'lon': 112.0156, 'level': '4A'},
    'å¤ªè¡Œå±±å¤§å³¡è°·': {'lat': 36.3559, 'lon': 113.4145, 'level': '4A'},
    'ç‹å®¶å¤§é™¢': {'lat': 37.4226, 'lon': 111.9836, 'level': '4A'},
    'å…³å¸åº™': {'lat': 37.7152, 'lon': 110.5489, 'level': '4A'}
}
```

### æ ¸å¿ƒä»£ç ç¤ºä¾‹

```python
# processors/data_processing_core.py:321-334
# è®¡ç®—åˆ°æœ€è¿‘æ™¯åŒºçš„è·ç¦»
distances_to_scenic = []
for idx, row in enhanced_df.iterrows():
    if pd.isna(row['lat']) or pd.isna(row['lon']):
        distances_to_scenic.append({'nearest_scenic': None, 'distance_km': None})
    else:
        nearest, distance = self._find_nearest_scenic(row['lat'], row['lon'])
        distances_to_scenic.append({
            'nearest_scenic': nearest,
            'distance_km': distance
        })

scenic_df = pd.DataFrame(distances_to_scenic)
enhanced_df = pd.concat([enhanced_df, scenic_df], axis=1)
```

---

## ğŸ¯ æ¼”ç¤ºè¯æœ¯

### å¼€åœºä»‹ç»ï¼ˆ30ç§’ï¼‰

```
"ä¿¡ä»¤æ•°æ®æ˜¯ç¦»æ•£çš„åŸºç«™è®°å½•ï¼Œä½†æˆ‘ä»¬èƒ½çœ‹åˆ°ç”¨æˆ·çš„ç§»åŠ¨è½¨è¿¹ã€‚

æˆ‘ä»¬é€šè¿‡è½¨è¿¹é‡æ„ç®—æ³•ï¼Œå°†ç¦»æ•£çš„åŸºç«™è®°å½•è½¬æ¢ä¸ºè¿ç»­çš„ç§»åŠ¨è·¯å¾„ï¼Œ
å¹¶è®¡ç®—ç”¨æˆ·ä¸å„å¤§æ™¯åŒºçš„è·ç¦»å…³ç³»ã€‚

è¿™ä¸ºè·¨åŒºåŸŸæµåŠ¨åˆ†æå’Œæ™¯åŒºæœåŠ¡èŒƒå›´åˆ†ææä¾›äº†æ•°æ®åŸºç¡€ã€‚"
```

### æ·±åº¦è®²è§£ï¼ˆ2åˆ†é’Ÿï¼‰

```
"æˆ‘ä»¬çš„è½¨è¿¹é‡æ„åŒ…å«ä¸¤ä¸ªå…³é”®æ­¥éª¤ï¼š

ç¬¬ä¸€æ­¥ï¼šåŸºç«™åœ°ç†æ˜ å°„
è¿™æ˜¯æˆ‘ä»¬é¦–åˆ›çš„ç®—æ³•ï¼ˆå·²åœ¨æ–‡æ¡£01ä¸­è¯¦ç»†ä»‹ç»ï¼‰ï¼Œ
å°†åŸºç«™IDè½¬æ¢ä¸ºç»çº¬åº¦åæ ‡ï¼Œè®©æ¯æ¡è®°å½•éƒ½æœ‰åœ°ç†ä½ç½®

ç¬¬äºŒæ­¥ï¼šè½¨è¿¹åºåˆ—é‡æ„
æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ç”¨æˆ·çš„åŸºç«™è®°å½•ï¼Œ
å½¢æˆè¿ç»­çš„ç§»åŠ¨è·¯å¾„ï¼šå¤ªåŸ â†’ æ™‹ä¸­ â†’ è¿åŸ...

ç¬¬ä¸‰æ­¥ï¼šç©ºé—´å…³ç³»è®¡ç®—
è®¡ç®—æ¯ä¸ªä½ç½®åˆ°æœ€è¿‘æ™¯åŒºçš„è·ç¦»ï¼Œ
è¿™æ ·æˆ‘ä»¬å°±èƒ½çŸ¥é“æ¸¸å®¢æ˜¯å¦åˆ°è®¿è¿‡æŸä¸ªæ™¯åŒº

ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·åœ¨å¹³é¥å¤åŸé™„è¿‘çš„åŸºç«™å‡ºç°æ—¶ï¼Œ
æˆ‘ä»¬å°±èƒ½åˆ¤æ–­è¯¥ç”¨æˆ·å¯èƒ½æ¸¸è§ˆäº†å¹³é¥å¤åŸ

è¿™å¯¹äºåˆ†ææ¸¸å®¢æµåŠ¨è·¯å¾„ã€æ™¯åŒºæœåŠ¡èŒƒå›´éƒ½éå¸¸é‡è¦ã€‚"
```

### æ¼”ç¤ºäº’åŠ¨ï¼ˆ1åˆ†é’Ÿï¼‰

```
ï¼ˆå±•ç¤ºæ”¿åºœç«¯å®¢æµæµåŠ¨å›¾è¡¨ï¼‰

"å„ä½è¯„å§”è¯·çœ‹ï¼Œè¿™ä¸ªè·¨åŒºåŸŸå®¢æµæµåŠ¨è¡¨æ ¼ï¼š

æ‚¨å¯ä»¥çœ‹åˆ°ï¼š
- ä»åŒ—äº¬åˆ°å¤§åŒçš„å®¢æµï¼š3456äºº
- ä»æ²³åŒ—åˆ°å¿»å·çš„å®¢æµï¼š2134äºº
- ä»é™•è¥¿åˆ°è¿åŸçš„å®¢æµï¼š1876äºº

è¿™äº›æµåŠ¨æ•°æ®å°±æ˜¯åŸºäºè½¨è¿¹é‡æ„ç®—æ³•è®¡ç®—å‡ºæ¥çš„ã€‚

æˆ‘ä»¬é€šè¿‡åˆ†æç”¨æˆ·çš„åŸºç«™è®°å½•è½¨è¿¹ï¼Œ
è¯†åˆ«å‡ºç”¨æˆ·çš„å‡ºå‘åœ°å’Œç›®çš„åœ°ï¼Œ
ä»è€Œå½¢æˆè¿™æ ·çš„å®¢æµæµåŠ¨åˆ†æã€‚

è¿™ä¸ºæ”¿åºœåˆ¶å®šäº¤é€šæ”¿ç­–ã€æ—…æ¸¸çº¿è·¯è§„åˆ’æä¾›äº†æ•°æ®æ”¯æ’‘ã€‚"
```

### æ€»ç»“å¼ºè°ƒï¼ˆ30ç§’ï¼‰

```
"è½¨è¿¹é‡æ„ä¸è·ç¦»è®¡ç®—çš„ä»·å€¼ï¼š

â‘  æ•°æ®ä»·å€¼åŒ–ï¼šç¦»æ•£è®°å½• â†’ è¿ç»­è½¨è¿¹
â‘¡ ç©ºé—´åˆ†æï¼šæ”¯æŒæµåŠ¨åˆ†æå’Œè¦†ç›–åˆ†æ
â‘¢ ä¸šåŠ¡åº”ç”¨ï¼šå®¢æµæµåŠ¨ã€æ™¯åŒºæœåŠ¡èŒƒå›´
â‘£ ç²¾åº¦å¯é ï¼šæ¬§å‡ é‡Œå¾—è·ç¦»ï¼Œè¯¯å·®Â±5km

è¿™æ˜¯æˆ‘ä»¬æ•°æ®å¤„ç†ç®¡é“çš„å…³é”®ç¯èŠ‚ï¼"
```

---

## ğŸ“Š å¯¹æ¯”ä¼˜åŠ¿

### ä¸ä¼ ç»Ÿæ–¹æ³•å¯¹æ¯”

| ç»´åº¦ | ä¼ ç»Ÿæ–¹æ³• | æˆ‘ä»¬çš„æ–¹æ³• |
|-----|---------|----------|
| è½¨è¿¹è¡¨ç¤º | ç¦»æ•£ç‚¹ | è¿ç»­è·¯å¾„ |
| è·ç¦»è®¡ç®— | ç›´çº¿è·ç¦»(æœªè½¬km) | æ¬§å‡ é‡Œå¾—è·ç¦»(km) |
| æ™¯åŒºå…³è” | æ‰‹åŠ¨åŒ¹é… | è‡ªåŠ¨è®¡ç®—æœ€è¿‘è·ç¦» |
| åº”ç”¨åœºæ™¯ | å•ä¸€ | å¤šæ ·(æµåŠ¨/è¦†ç›–) |

### è·ç¦»è®¡ç®—ç²¾åº¦å¯¹æ¯”

| ç®—æ³• | ç²¾åº¦ | è®¡ç®—é€Ÿåº¦ | é€‚ç”¨èŒƒå›´ |
|-----|------|---------|---------|
| æ¬§å‡ é‡Œå¾—è·ç¦» | Â±5km | å¿« | å°èŒƒå›´(<100km) |
| Haversineå…¬å¼ | Â±1km | æ…¢ | å…¨çƒèŒƒå›´ |
| æˆ‘ä»¬çš„å®ç° | Â±5km | å¿« | çœçº§èŒƒå›´ |

---

## ğŸš€ åº”ç”¨åœºæ™¯/æ‰©å±•æ€§

### åº”ç”¨åœºæ™¯

1. **å®¢æµæµåŠ¨åˆ†æ**: è¯†åˆ«è·¨åŒºåŸŸæ¸¸å®¢æµåŠ¨è·¯å¾„
2. **æ™¯åŒºè¦†ç›–åˆ†æ**: è®¡ç®—æ™¯åŒºæœåŠ¡åŠå¾„å’Œè¦†ç›–èŒƒå›´
3. **æ¸¸å®¢è·¯å¾„è§„åˆ’**: åŸºäºå†å²è½¨è¿¹æ¨èæ—…æ¸¸çº¿è·¯
4. **å®¢æºåœ°åˆ†æ**: æ ¹æ®é¦–æ¬¡å‡ºç°ä½ç½®æ¨æ–­å®¢æºåœ°

### æ‰©å±•æ€§

1. **æ›´é«˜ç²¾åº¦**: å¯å¼•å…¥Haversineå…¬å¼æé«˜ç²¾åº¦
2. **è½¨è¿¹èšç±»**: è¯†åˆ«çƒ­é—¨æ—…æ¸¸è·¯çº¿
3. **æ—¶é—´çº¦æŸ**: æ·»åŠ æ—¶é—´ç»´åº¦åˆ†ææ¸¸è§ˆæ—¶é•¿
4. **å¤šç›®çš„åœ°**: è¯†åˆ«å¤šç›®çš„åœ°æ¸¸è§ˆæ¨¡å¼

---

## ğŸ“ˆ æ•°æ®å¤„ç†æµç¨‹

```
åŸå§‹ä¿¡ä»¤æ•°æ®
    â†“
ã€åŸºç«™åœ°ç†æ˜ å°„ã€‘
åŸºç«™ID â†’ (lat, lon, city)
    â†“
ã€è½¨è¿¹é‡æ„ã€‘
æŒ‰ç”¨æˆ·+æ—¶é—´æ’åº â†’ è¿ç»­è½¨è¿¹
    â†“
ã€è·ç¦»è®¡ç®—ã€‘
è®¡ç®—æ¯ä¸ªä½ç½®åˆ°15ä¸ªæ™¯åŒºçš„è·ç¦»
    â†“
ã€æœ€è¿‘æ™¯åŒºåŒ¹é…ã€‘
è¯†åˆ«æ¯ä¸ªä½ç½®æœ€è¿‘çš„æ™¯åŒº
    â†“
å¢å¼ºæ•°æ®é›†
å­—æ®µï¼š
- nearest_scenic: æœ€è¿‘æ™¯åŒºåç§°
- distance_km: è·ç¦»(å…¬é‡Œ)
- city: æ‰€åœ¨åŸå¸‚
- confidence: æ˜ å°„ç½®ä¿¡åº¦
```

---

## ğŸ† æ€»ç»“

### æ ¸å¿ƒä»·å€¼

1. **åˆ›æ–°æ€§**: â­â­â­
   - å°†ç¦»æ•£è®°å½•è½¬æ¢ä¸ºè¿ç»­è½¨è¿¹

2. **å®ç”¨æ€§**: â­â­â­â­â­
   - æ”¯æ’‘å®¢æµæµåŠ¨å’Œæ™¯åŒºè¦†ç›–åˆ†æ

3. **å‡†ç¡®æ€§**: â­â­â­â­
   - æ¬§å‡ é‡Œå¾—è·ç¦»è®¡ç®—ï¼Œç²¾åº¦Â±5km

### æ¼”ç¤ºå»ºè®®

- **æœ€ä½³å±•ç¤ºä½ç½®**: æ”¿åºœç«¯ â†’ å®¢æµæµåŠ¨åˆ†æ
- **æ¼”ç¤ºæ—¶é•¿**: 1-2åˆ†é’Ÿ
- **å…³é”®è¯æœ¯**: "è½¨è¿¹é‡æ„ï¼Œç¦»æ•£å˜è¿ç»­"
- **è§†è§‰å†²å‡»**: å®¢æµæµåŠ¨è¡¨æ ¼ + çƒ­åŠ›å›¾

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-01-02
**ä½œè€…**: å±±è¥¿æ–‡æ—…æ™ºèƒ½ä½“å›¢é˜Ÿ
