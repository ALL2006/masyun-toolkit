# 10 - 会话管理系统 💾

> **难度**: ⭐⭐⭐⭐ | **价值**: 🔥🔥🔥🔥 | **创新度**: ⭐⭐⭐⭐

---

## 📌 技术概述

### 核心功能

在智能对话场景中，**上下文记忆**至关重要。我们设计了完整的会话管理系统，实现：

| 功能 | 实现方式 |
|-----|---------|
| **多轮对话记忆** | 保存会话历史，传递给LLM |
| **会话隔离** | 每个session_id独立存储 |
| **过期清理** | 24小时未活动自动清理 |
| **容量管理** | 单会话最多20条消息 |

### 技术架构

```
用户会话 → SessionManager → SessionHistory → LLM API
    ↓              ↓                ↓
session_id    会话列表管理      消息历史存储
```

### 技术成果

| 指标 | 数值 |
|-----|-----|
| 最大会话数 | 1000个 |
| 单会话最大消息 | 20条 |
| 会话保留时长 | 24小时 |
| 清理间隔 | 5分钟 |

---

## 🔍 技术原理

### 会话管理架构

```python
class SessionManager:
    """会话管理器"""

    def __init__(
        self,
        max_sessions: int = 1000,           # 最大会话数
        max_messages_per_session: int = 20,  # 单会话最大消息数
        max_session_hours: int = 24,         # 会话保留时长
        cleanup_interval: int = 300          # 清理间隔(秒)
    ):
        self.sessions: Dict[str, SessionHistory] = {}
        self._cleanup_task = None
```

### 消息结构

```python
class SessionMessage:
    """会话消息"""

    def __init__(
        self,
        role: str,           # "user" 或 "assistant"
        content: str,        # 消息内容
        timestamp: datetime  # 时间戳
    ):
        self.role = role
        self.content = content
        self.timestamp = timestamp

    def to_dict(self) -> dict:
        """转换为LLM API格式"""
        return {"role": self.role, "content": self.content}
```

### 会话历史管理

```python
class SessionHistory:
    """会话历史"""

    def __init__(
        self,
        session_id: str,
        max_messages: int = 20,
        max_hours: int = 24
    ):
        self.session_id = session_id
        self.messages: List[SessionMessage] = []
        self.max_messages = max_messages
        self.max_hours = max_hours

    def add_message(self, role: str, content: str) -> None:
        """添加消息到历史"""
        message = SessionMessage(role, content)
        self.messages.append(message)

        # 超过最大消息数时，删除最旧的
        if len(self.messages) > self.max_messages:
            self.messages.pop(0)
```

---

## 💡 项目应用

### 代码位置

**主文件**: [backend/app/services/session_manager.py](../../backend/app/services/session_manager.py)

### 实现细节

#### 1. 会话消息定义

```python
# backend/app/services/session_manager.py:11-30
class SessionMessage:
    """会话消息"""

    def __init__(
        self,
        role: str,  # "user" 或 "assistant"
        content: str,
        timestamp: Optional[datetime] = None
    ):
        self.role = role
        self.content = content
        self.timestamp = timestamp or datetime.now()

    def to_dict(self) -> dict:
        """转换为字典格式（用于LLM API）"""
        return {
            "role": self.role,
            "content": self.content
        }
```

#### 2. 会话历史管理

```python
# backend/app/services/session_manager.py:32-100
class SessionHistory:
    """会话历史"""

    def __init__(
        self,
        session_id: str,
        max_messages: int = 20,
        max_hours: int = 24
    ):
        self.session_id = session_id
        self.messages: List[SessionMessage] = []
        self.max_messages = max_messages
        self.max_hours = max_hours
        self.created_at = datetime.now()
        self.last_updated = datetime.now()

    def add_message(self, role: str, content: str) -> None:
        """添加消息到历史"""
        message = SessionMessage(role, content)
        self.messages.append(message)
        self.last_updated = datetime.now()

        # 超过最大消息数时，删除最旧的消息
        if len(self.messages) > self.max_messages:
            if self.messages and self.messages[0].role == "system":
                if len(self.messages) > 1:
                    self.messages.pop(1)
            else:
                self.messages.pop(0)

    def get_history(self, include_system: bool = False) -> List[dict]:
        """获取历史记录（用于LLM API）"""
        history = []
        for msg in self.messages:
            if not include_system and msg.role == "system":
                continue
            history.append(msg.to_dict())
        return history

    def is_expired(self) -> bool:
        """检查会话是否过期"""
        now = datetime.now()
        hours_since_update = (now - self.last_updated).total_seconds() / 3600
        return hours_since_update > self.max_hours
```

#### 3. 会话管理器

```python
# backend/app/services/session_manager.py:103-232
class SessionManager:
    """会话管理器"""

    def __init__(
        self,
        max_sessions: int = 1000,
        max_messages_per_session: int = 20,
        max_session_hours: int = 24,
        cleanup_interval: int = 300
    ):
        self.sessions: Dict[str, SessionHistory] = {}
        self.max_sessions = max_sessions
        self.max_messages = max_messages_per_session
        self.max_hours = max_session_hours
        self.cleanup_interval = cleanup_interval
        self._cleanup_task = None

    def get_or_create_session(self, session_id: str) -> SessionHistory:
        """获取或创建会话"""
        if session_id not in self.sessions:
            # 会话数超限时，删除最旧的会话
            if len(self.sessions) >= self.max_sessions:
                oldest_id = min(
                    self.sessions.keys(),
                    key=lambda sid: self.sessions[sid].created_at
                )
                del self.sessions[oldest_id]

            # 创建新会话
            self.sessions[session_id] = SessionHistory(
                session_id=session_id,
                max_messages=self.max_messages,
                max_hours=self.max_hours
            )

        return self.sessions[session_id]

    def add_message(
        self,
        session_id: str,
        role: str,
        content: str
    ) -> None:
        """添加消息到会话"""
        session = self.get_or_create_session(session_id)
        session.add_message(role, content)

    def get_history(self, session_id: str) -> List[dict]:
        """获取会话历史"""
        if session_id not in self.sessions:
            return []

        session = self.sessions[session_id]
        session.clear_old_messages()
        return session.get_llm_history()

    def cleanup_expired(self) -> int:
        """清理所有过期的会话"""
        expired_ids = [
            sid for sid, session in self.sessions.items()
            if session.is_expired()
        ]

        for sid in expired_ids:
            del self.sessions[sid]

        return len(expired_ids)
```

#### 4. 全局单例

```python
# backend/app/services/session_manager.py:224-232
# 全局会话管理器实例
_global_session_manager: Optional[SessionManager] = None

def get_session_manager() -> SessionManager:
    """获取全局会话管理器实例"""
    global _global_session_manager
    if _global_session_manager is None:
        _global_session_manager = SessionManager()
    return _global_session_manager
```

#### 5. 集成到聊天服务

```python
# backend/app/services/real_service.py:99-148
async def chat(
    self,
    message: str,
    session_id: Optional[str] = None,
    context: Optional[dict] = None
) -> dict:
    """智能对话（使用真实LLM API，支持会话历史）"""

    # 获取会话历史
    history = None
    if session_id:
        from app.services.session_manager import get_session_manager
        session_mgr = get_session_manager()
        history = session_mgr.get_history(session_id)

    # 调用LLM API
    response = await self._llm_client.chat_with_suggestions(
        message=message,
        history=history
    )

    # 保存对话到会话历史
    if session_id:
        session_mgr.add_message(session_id, "user", message)
        session_mgr.add_message(session_id, "assistant", response["reply"])

    return response
```

### 核心代码示例

```python
# backend/app/services/session_manager.py:158-176
def add_message(
    self,
    session_id: str,
    role: str,
    content: str
) -> None:
    """添加消息到会话"""
    session = self.get_or_create_session(session_id)
    session.add_message(role, content)

def get_history(self, session_id: str) -> List[dict]:
    """获取会话历史"""
    if session_id not in self.sessions:
        return []

    session = self.sessions[session_id]
    session.clear_old_messages()
    return session.get_llm_history()
```

---

## 🎯 演示话术

### 开场介绍（30秒）

```
"智能对话需要记住上下文。

我们设计了完整的会话管理系统，
能够保存用户的对话历史，
让LLM理解之前的对话内容。

这样用户就可以进行多轮连续对话。"
```

### 深度讲解（2分钟）

```
"会话管理系统包含三个核心组件：

第一层：SessionMessage
每条消息包含角色、内容和时间戳，
可以转换为LLM API需要的格式。

第二层：SessionHistory
管理单个会话的消息历史，
包括：
- 最多保存20条消息
- 超过时自动删除旧消息
- 24小时未活动自动过期

第三层：SessionManager
管理所有会话的生命周期，
包括：
- 最多1000个并发会话
- 超限时删除最旧的会话
- 定期清理过期会话

使用流程：
1. 用户发起对话，携带session_id
2. 系统获取或创建会话
3. 从历史中获取之前的对话
4. 将历史传递给LLM
5. 保存新的对话到历史

这个设计确保了：
- 用户的对话上下文得以保存
- 多轮对话体验流畅自然
- 系统资源得到有效管理"
```

### 演示互动（1分钟）

```
（切换到游客端对话页面）

"各位评委请看，这是智能对话界面：

当我和AI对话时：
- 我：'山西有哪些好玩的地方？'
- AI：'推荐平遥古城、五台山、云冈石窟...'

然后我继续问：'这些地方门票多少钱？'
AI能够理解我指的是上面提到的景点，
因为我之前的对话历史已经保存并传递给LLM了。

您可以看到建议问题按钮也在变化，
这同样依赖于对话上下文。

这个会话管理功能让对话体验更加自然流畅。"
```

### 总结强调（30秒）

```
"会话管理系统的价值：

① 上下文记忆：保存对话历史，支持多轮对话
② 会话隔离：每个用户独立会话
③ 资源管理：自动清理过期会话
④ 用户体验：自然流畅的对话体验

这是智能对话系统的核心能力！"
```

---

## 📊 对比优势

### 与无状态API对比

| 维度 | 无状态API | 会话管理 |
|-----|----------|---------|
| 上下文记忆 | ❌ 无 | ✅ 有 |
| 多轮对话 | ❌ 不支持 | ✅ 支持 |
| 用户体验 | 差 | 好 |
| 资源消耗 | 低 | 中等 |

### 会话管理方案对比

| 方案 | 内存存储 | Redis | 我们的方案 |
|-----|---------|-------|----------|
| 复杂度 | 低 | 高 | 中 |
| 持久化 | ❌ | ✅ | ❌（内存） |
| 清理机制 | 手动 | 自动TTL | 自动清理 |
| 适用场景 | 小规模 | 大规模 | 中小规模 |

---

## 🚀 应用场景/扩展性

### 应用场景

1. **智能对话**: 保存对话上下文，支持多轮对话
2. **用户画像**: 基于历史对话分析用户偏好
3. **对话分析**: 分析用户对话模式和行为
4. **A/B测试**: 对比不同对话策略的效果

### 扩展性

可以扩展为持久化存储：

```python
# 使用Redis扩展
class RedisSessionManager(SessionManager):
    """Redis会话管理器"""

    def __init__(self, redis_client):
        self.redis = redis_client
        self.ttl = 24 * 3600  # 24小时

    def add_message(self, session_id: str, role: str, content: str):
        """保存到Redis"""
        key = f"session:{session_id}"
        message = {"role": role, "content": content}
        self.redis.lpush(key, json.dumps(message))
        self.redis.expire(key, self.ttl)

    def get_history(self, session_id: str):
        """从Redis获取"""
        key = f"session:{session_id}"
        messages = self.redis.lrange(key, 0, -1)
        return [json.loads(m) for m in messages]
```

---

## 📈 会话生命周期

```
用户发起对话（携带session_id）
    ↓
┌─────────────────────────────────────────┐
│         SessionManager                  │
│  检查session_id是否存在于sessions中      │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│    session_id存在？                      │
│         ↓              ↓               │
│        是            否                 │
│         ↓              ↓               │
│  获取已有会话      创建新会话            │
│  (SessionHistory)  (SessionHistory)    │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│         获取历史消息                     │
│  session.get_history()                  │
│  ↓                                      │
│  返回最近20条消息（去除system消息）       │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│         调用LLM API                      │
│  传递history参数                         │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│         保存新消息                       │
│  session.add_message("user", message)    │
│  session.add_message("assistant", reply) │
└─────────────────────────────────────────┘
    ↓
    后台清理任务（每5分钟）
    ↓
┌─────────────────────────────────────────┐
│         清理过期会话                     │
│  删除24小时未活动的会话                   │
└─────────────────────────────────────────┘
```

---

## 🏆 总结

### 核心价值

1. **用户体验**: ⭐⭐⭐⭐⭐
   - 多轮对话，上下文连贯

2. **技术实现**: ⭐⭐⭐⭐⭐
   - 自动清理，资源管理

3. **可扩展性**: ⭐⭐⭐⭐⭐
   - 可扩展为Redis持久化

### 演示建议

- **最佳展示位置**: 游客端对话演示
- **演示时长**: 1-2分钟
- **关键话术**: "会话管理，记住上下文"
- **视觉冲击**: 多轮对话演示

---

**文档版本**: v1.0
**最后更新**: 2026-01-02
**作者**: 山西文旅智能体团队
