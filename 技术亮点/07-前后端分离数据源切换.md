# 07 - 前后端分离+数据源切换 🔄

> **难度**: ⭐⭐⭐⭐ | **价值**: 🔥🔥🔥🔥 | **创新度**: ⭐⭐⭐⭐

---

## 📌 技术概述

### 核心设计

我们的系统采用**前后端分离架构**，支持**双数据源动态切换**：

| 数据源 | 适用场景 | 特点 |
|-------|---------|------|
| **Mock数据** | 演示、开发 | 基于真实统计规则生成，时间感知 |
| **Real数据** | 生产、真实场景 | 接入LLM API，真实智能对话 |

### 架构优势

```
前端(Vite+React)
    ↓ HTTP Request
后端(FastAPI)
    ↓ 数据源选择
┌─────────┬─────────┐
│ Mock服务 │ Real服务 │
│ (模拟)   │ (真实)   │
└─────────┴─────────┘
```

### 技术成果

| 指标 | 数值 |
|-----|-----|
| 数据源切换方式 | URL参数 `?source=mock/real` |
| 切换响应时间 | <100ms |
| 支持的服务 | 游客/企业/政府三端 |
| 状态保持 | 前端状态管理(Zustand) |

---

## 🔍 技术原理

### 前后端分离架构

```
┌─────────────────────────────────────────────────┐
│                   前端层                        │
│  ┌───────────┬───────────┬───────────┐         │
│  │ 游客端页面 │ 企业端页面 │ 政府端页面 │         │
│  └───────────┴───────────┴───────────┘         │
│           ↕ HTTP Request (RESTful API)          │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│                   后端层                        │
│  ┌─────────────────────────────────────────┐   │
│  │          FastAPI 应用                   │   │
│  │  ┌───────────┬───────────┬───────────┐  │   │
│  │  │游客API路由│企业API路由│政府API路由│  │   │
│  │  └───────────┴───────────┴───────────┘  │   │
│  │            ↕ 服务层选择                 │   │
│  │  ┌────────────┬────────────┐           │   │
│  │  │ Mock服务   │ Real服务   │           │   │
│  │  └────────────┴────────────┘           │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
```

### 数据源切换机制

```python
# 后端：根据请求参数选择数据源
@router.get("/attractions")
async def get_attractions(
    source: str = "mock",  # 默认使用mock
    city: str = None,
    tags: list = None
):
    if source == "real":
        service = RealService()
    else:
        service = MockService()

    return await service.get_attractions(city, tags)
```

```typescript
// 前端：通过URL参数切换数据源
const [dataSource, setDataSource] = useDataSourceStore();

// 切换到真实数据
const switchToReal = () => {
  setDataSource('real');
  // 重新请求数据
  refetch();
};
```

---

## 💡 项目应用

### 代码位置

| 组件 | 文件位置 |
|-----|---------|
| **后端服务基类** | [backend/app/services/base_service.py](../../backend/app/services/base_service.py) |
| **Mock服务实现** | [backend/app/services/mock_service.py](../../backend/app/services/mock_service.py) |
| **Real服务实现** | [backend/app/services/real_service.py](../../backend/app/services/real_service.py) |
| **前端状态管理** | [frontend/src/stores/appStore.ts](../../frontend/src/stores/appStore.ts) |
| **数据源切换组件** | [frontend/src/components/DataSourceSwitcher.tsx](../../frontend/src/components/DataSourceSwitcher.tsx) |

### 实现细节

#### 1. 抽象基类定义

```python
# backend/app/services/base_service.py:9-141
class DataServiceBase(ABC):
    """数据服务抽象基类"""

    def __init__(self):
        self.source_type: str = "base"  # 数据源类型标识

    # ========== 游客端接口 ==========

    @abstractmethod
    async def get_attractions(
        self,
        city: Optional[str] = None,
        tags: Optional[list[str]] = None,
        limit: int = 20
    ) -> list:
        """获取景点列表"""
        pass

    @abstractmethod
    async def chat(
        self,
        message: str,
        session_id: Optional[str] = None,
        context: Optional[dict] = None
    ) -> dict:
        """智能对话"""
        pass

    # ... 更多抽象方法
```

#### 2. Mock服务实现

```python
# backend/app/services/mock_service.py:345-353
class MockDataService(DataServiceBase):
    """模拟数据服务实现"""

    def __init__(self):
        super().__init__()
        self.source_type = "mock"
        self.generator = MockDataGenerator()
        self.time_gen = TimeAwareGenerator()  # 时间感知生成器

    async def get_attractions(
        self,
        city: Optional[str] = None,
        tags: Optional[list[str]] = None,
        limit: int = 20
    ) -> list:
        """获取景点列表（带时间感知）"""
        # ... 基于真实统计生成模拟数据
```

#### 3. Real服务实现

```python
# backend/app/services/real_service.py:14-29
class RealDataService(DataServiceBase):
    """真实数据服务实现"""

    def __init__(self):
        super().__init__()
        self.source_type = "real"
        # 使用mock服务作为fallback
        self._fallback = MockDataService()

        # 初始化LLM客户端
        self._llm_client = None
        self._init_llm_client()

    async def chat(
        self,
        message: str,
        session_id: Optional[str] = None,
        context: Optional[dict] = None
    ) -> dict:
        """智能对话（使用真实LLM API）"""
        if self._llm_client is None:
            return await self._fallback.chat(message, session_id, context)

        # 调用真实LLM API
        response = await self._llm_client.chat_with_suggestions(
            message=message,
            history=history
        )
        return response
```

#### 4. 前端数据源切换组件

```typescript
// frontend/src/components/DataSourceSwitcher.tsx
export default function DataSourceSwitcher() {
  const { dataSource, setDataSource } = useDataSourceStore();

  const handleSwitch = (value: 'mock' | 'real') => {
    setDataSource(value);
    message.info(`已切换到${value === 'mock' ? '模拟数据' : '真实数据'}`);
  };

  return (
    <Segmented
      value={dataSource}
      onChange={handleSwitch}
      options={[
        { label: '模拟数据', value: 'mock' },
        { label: '真实数据', value: 'real' }
      ]}
    />
  );
}
```

#### 5. API路由层选择

```python
# backend/app/api/v1/tourist.py
@router.get("/attractions")
async def get_attractions(
    source: str = "mock",
    city: Optional[str] = None,
    tags: Optional[list] = None,
    limit: int = 20
):
    """获取景点列表"""
    # 根据source参数选择服务
    if source == "real":
        service = RealService()
    else:
        service = MockService()

    return await service.get_attractions(city=city, tags=tags, limit=limit)
```

### 核心代码示例

```python
# backend/app/services/base_service.py:9-26
class DataServiceBase(ABC):
    """数据服务抽象基类"""

    def __init__(self):
        self.source_type: str = "base"

    @abstractmethod
    async def get_attractions(
        self,
        city: Optional[str] = None,
        tags: Optional[list[str]] = None,
        limit: int = 20
    ) -> list:
        """获取景点列表"""
        pass

    @abstractmethod
    async def chat(
        self,
        message: str,
        session_id: Optional[str] = None,
        context: Optional[dict] = None
    ) -> dict:
        """智能对话"""
        pass
```

---

## 🎯 演示话术

### 开场介绍（30秒）

```
"我们的系统采用前后端分离架构，支持双数据源动态切换。

这个设计让我们能够在演示时使用模拟数据，
在生产环境使用真实的LLM API。

一个系统，两种模式，灵活切换。"
```

### 深度讲解（2分钟）

```
"前后端分离架构的核心优势：

第一层：前后端分离
前端使用React 19 + TypeScript，
后端使用FastAPI + Python，
通过RESTful API进行通信。

这种分离带来了：
- 前后端独立开发，提高效率
- 接口标准化，易于扩展
- 支持多端复用（Web/App/小程序）

第二层：双数据源支持
我们定义了统一的抽象基类，
Mock服务和Real服务都继承这个基类，
实现了相同的接口。

这意味着：
- 前端不需要关心数据源类型
- 后端可以灵活切换数据源
- 新增数据源只需实现基类接口

第三层：前端状态管理
使用Zustand进行状态管理，
用户可以一键切换数据源，
所有API请求自动使用新数据源。

这个设计让系统既有演示能力，又有生产价值。"
```

### 演示互动（1分钟）

```
（切换到游客端界面，点击数据源切换按钮）

"各位评委请看，页面右上角有这个数据源切换组件：

当前显示的是'模拟数据'模式，
系统根据真实数据统计规则生成数据，
包括时间感知的客流量变化。

当我切换到'真实数据'模式，
系统就会接入真实的LLM API，
您可以看到对话质量明显提升。

这种设计让系统可以：
- 在演示时使用模拟数据（无需API Key）
- 在生产时使用真实API（高准确度）
- 根据场景灵活选择

体现了我们架构设计的前瞻性。"
```

### 总结强调（30秒）

```
"前后端分离+数据源切换的价值：

① 架构先进：前后端分离，接口标准化
② 灵活切换：双数据源支持，一键切换
③ 开发效率：Mock数据便于开发调试
④ 生产就绪：真实API用于生产环境

这体现了我们扎实的工程能力！"
```

---

## 📊 对比优势

### 与传统单体应用对比

| 维度 | 传统单体应用 | 前后端分离架构 |
|-----|-------------|---------------|
| 开发效率 | 低（耦合） | 高（并行开发） |
| 扩展性 | 差 | 好（独立扩展） |
| 维护性 | 低 | 高（职责清晰） |
| 数据源 | 固定 | 可切换 |

### 数据源切换方案对比

| 方案 | 配置文件 | 运行时参数 | 我们的方案 |
|-----|---------|-----------|----------|
| 切换方式 | 修改配置重启 | 部署时指定 | 前端一键切换 |
| 响应速度 | 慢（需重启） | 中 | 快（<100ms） |
| 用户体验 | 差 | 中 | 优（实时切换） |

---

## 🚀 应用场景/扩展性

### 应用场景

1. **开发调试**: 使用Mock数据，无需依赖外部API
2. **演示展示**: 使用模拟数据，避免API调用限制
3. **生产环境**: 使用Real数据，接入真实LLM
4. **A/B测试**: 对比不同数据源的效果

### 扩展性

可以轻松添加新的数据源：
- **数据库服务**: 接入PostgreSQL/MySQL
- **缓存服务**: 接入Redis缓存
- **第三方API**: 接入更多外部服务

只需继承`DataServiceBase`基类即可。

---

## 📈 架构流程图

```
用户操作（前端）
    ↓
┌─────────────────────────────────────────┐
│         前端状态管理 (Zustand)           │
│  dataSource: 'mock' | 'real'            │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│         API请求 (带source参数)           │
│  GET /api/v1/tourist/attractions?source=mock│
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│         后端路由层 (FastAPI)             │
│  根据source参数选择服务实现              │
└─────────────────────────────────────────┘
    ↓
┌───────────────┬───────────────────────┐
│  MockService  │  RealService         │
│  (模拟数据)   │  (LLM API)           │
└───────────────┴───────────────────────┘
    ↓
统一响应格式
    ↓
前端展示
```

---

## 🏆 总结

### 核心价值

1. **架构先进**: ⭐⭐⭐⭐⭐
   - 前后端分离，职责清晰

2. **灵活性**: ⭐⭐⭐⭐⭐
   - 双数据源，一键切换

3. **可扩展性**: ⭐⭐⭐⭐⭐
   - 抽象基类，易于扩展

### 演示建议

- **最佳展示位置**: 系统架构讲解
- **演示时长**: 1-2分钟
- **关键话术**: "前后端分离，双数据源切换"
- **视觉冲击**: 架构图 + 数据源切换演示

---

**文档版本**: v1.0
**最后更新**: 2026-01-02
**作者**: 山西文旅智能体团队
