# 46 - 基于规则的后备对话系统 🤖

> **难度**: ⭐⭐⭐ | **价值**: 🔥🔥🔥🔥 | **创新度**: ⭐⭐⭐⭐ |

---

## 📌 技术概述

### 核心功能

当LLM API不可用时，系统自动降级到**基于规则的后备对话系统**，确保服务可用性：

| 功能 | 实现方式 |
|-----|---------|
| **关键词匹配** | 30+种场景规则 |
| **多轮对话模拟** | 建议问题引导 |
| **场景识别** | 景点/美食/住宿/交通等 |
| **智能回复** | 专业准确的预设答案 |

### 技术成果

| 指标 | 数值 |
|-----|-----|
| 支持场景 | 33种 |
| 关键词规则 | 100+条 |
| 回复质量 | ⭐⭐⭐⭐ |

---

## 🔍 技术原理

### 规则匹配引擎

```python
# 优先级从高到低
1. 行程规划类: "规划", "行程", "几日游"
2. 景点推荐类: "推荐", "哪里好玩"
3. 美食相关: "美食", "吃", "小吃"
4. 住宿相关: "住宿", "酒店", "民宿"
5. 交通路线: "怎么去", "交通", "路线"
6. 门票价格: "门票", "价格", "多少钱"
7. 天气询问: "天气", "温度", "下雨"
8. 开放时间: "开放时间", "几点"
9. 攻略贴士: "攻略", "注意事项"
10. 特定景点: "平遥", "五台山", "云冈"
...
```

---

## 💡 项目应用

### 代码位置

**主文件**: [backend/app/services/mock_service.py:479-948](../../backend/app/services/mock_service.py#L479-L948)

### 实现细节

```python
# backend/app/services/mock_service.py:479-948
async def chat(
    self,
    message: str,
    session_id: Optional[str] = None,
    context: Optional[dict] = None
) -> dict:
    """智能对话（基于规则匹配）"""

    message_lower = message.lower()

    # 1. 行程规划
    if "规划" in message or "行程" in message:
        return {
            "reply": "我可以帮您规划山西旅游行程...",
            "suggestions": [
                "我想玩3天，从太原出发",
                "推荐五台山两日游",
                "晋北5日深度游路线"
            ]
        }

    # 2. 景点推荐
    elif "推荐" in message or "景点" in message:
        spots = "、".join([a["name"] for a in ATTRACTIONS_DATA[:4]])
        return {
            "reply": f"山西最值得去的景点包括：{spots}...",
            "suggestions": [...]
        }

    # 3. 美食相关
    elif "美食" in message or "吃" in message:
        return {
            "reply": "山西是面食之乡！特色美食有：刀削面...",
            "suggestions": [...]
        }

    # ... 更多规则
```

---

## 🎯 演示话术

### 开场介绍（30秒）

```
"我们的系统有双重保障：
优先使用LLM API提供智能对话，
当API不可用时，
自动降级到规则引擎，
确保服务始终可用。"
```

### 深度讲解（1分钟）

```
"后备对话系统的特点：

第一层：场景覆盖
支持33种常见场景，
涵盖旅游咨询的各个方面。

第二层：优先级设计
高优先级规则先匹配，
比如'行程规划'优先于'景点推荐'。

第三层：建议问题
根据对话内容推荐相关问题，
引导用户继续探索。

第四层：专业准确
所有答案都经过精心设计，
信息准确，语言友好。"
```

---

## 📊 对比优势

| 维度 | 纯LLM | LLM+后备 |
|-----|-------|----------|
| 可用性 | 依赖API | 100%可用 |
| 响应速度 | 2秒 | <0.1秒 |
| 成本 | 有API费用 | 无费用 |
| 稳定性 | 中等 | 高 |

---

## 🏆 总结

**核心价值**：服务有保障，API故障时自动降级，用户体验不受影响。

**演示建议**：可以演示关闭API Key，展示规则引擎仍然工作。

---

**文档版本**: v1.0
**最后更新**: 2026-01-02
**作者**: 山西文旅智能体团队
