# 📋 TimelineFlow 发布验证流程指南

> **目标**: 确保本地验证通过 = GitHub 上传后一定可用
>
> **总耗时**: 约 5 分钟
>
> **验证原则**: 宁可多花时间，确保万无一失

---

## 🎯 三层验证机制概览

```
代码修改完成
    ↓
┌─────────────────────────────────────────┐
│ 第1层：快速验证 (30秒)                   │
│ ✓ 编译通过                               │
│ ✓ 构建产物结构正确                       │
└─────────────────────────────────────────┘
    ↓ 失败 → 修复代码，重新开始
    ↓ 通过
┌─────────────────────────────────────────┐
│ 第2层：构建产物验证 (2-3分钟) ⭐关键     │
│ ✓ 浏览器运行构建后的版本                 │
│ ✓ 测试所有核心功能                       │
│ ✓ 模拟用户真实使用场景                   │
└─────────────────────────────────────────┘
    ↓ 失败 → 检查控制台错误，修复后重新开始
    ↓ 通过
┌─────────────────────────────────────────┐
│ 第3层：打包应用验证 (3-5分钟) ⭐⭐最终   │
│ ✓ 快速打包测试                          │
│ ✓ 完整安装测试                          │
│ ✓ 数据持久化验证                        │
└─────────────────────────────────────────┘
    ↓ 失败 → 查看日志，修复后重新开始
    ↓ 通过
上传到 GitHub ✅
```

---

## 📝 第1层：快速验证 (30秒)

**目的**: 确保代码能成功编译，构建产物结构正确

**命令**:
```bash
npm run verify:l1
```

**预期结果**:
```
✅ 第1层验证通过：编译成功
```

**手动检查**:
```bash
# 1. 检查 build 文件夹是否存在
dir build

# 2. 检查关键文件
# ✅ build/index.html 存在
# ✅ build/static/ 文件夹存在
# ✅ build/asset-manifest.json 存在
```

**可能的问题**:
| 错误 | 原因 | 解决方案 |
|------|------|---------|
| TypeScript 错误 | 类型不匹配 | 修复类型错误 |
| Module not found | 缺少依赖 | `npm install` |
| Build failed | 代码语法错误 | 检查控制台错误信息 |

**⚠️ 第1层失败，不要继续！**

---

## 🌐 第2层：构建产物验证 (2-3分钟) ⭐关键

**目的**: 在浏览器中运行打包后的代码，模拟真实使用

**为什么这是关键？**
```
很多白屏问题：编译通过 ✅ → 但构建产物有问题 ❌
第2层能捕捉 80% 的潜在问题！
```

### 步骤 A: 启动静态服务器

**命令**:
```bash
npm run verify:l2
```

**预期输出**:
```
i - Serving: build\
   - Local: http://localhost:5000
```

### 步骤 B: 浏览器测试

**操作**:
1. 打开浏览器访问 `http://localhost:5000`
2. 打开开发者工具 (F12)
3. 检查 **Console** 标签页是否有错误

### 步骤 C: 功能测试清单

逐项测试，每项通过后打钩：

**基础功能**:
- [ ] 页面正常加载，不是白屏
- [ ] 时间线组件正常显示
- [ ] 当前日期高亮显示
- [ ] 周/月视图切换按钮可以点击

**任务管理**:
- [ ] **创建任务**: 点击空白处能创建新任务
- [ ] **编辑任务**: 点击任务能打开编辑对话框
- [ ] **修改时间**: 能修改开始/结束时间
- [ ] **修改优先级**: 能选择不同优先级（颜色变化）
- [ ] **删除任务**: 删除后任务从时间线消失
- [ ] **拖拽调整**: 能拖拽任务调整时间

**数据持久化**:
- [ ] **保存数据**: 创建任务后
- [ ] **数据恢复**: 刷新页面 (F5)，数据还在

### 步骤 D: 关闭服务器

测试完成后，在命令行按 `Ctrl + C` 停止服务器。

### 常见问题排查

| 症状 | 可能原因 | 排查方法 |
|------|---------|---------|
| 白屏 | index.html 路径错误 | 检查 `homepage: "./"` |
| 控制台 404 | 静态资源路径错误 | 检查构建产物结构 |
| React 报错 | 运行时错误 | 查看具体错误信息 |
| 刷新后数据丢失 | localStorage 失败 | 检查浏览器是否禁用本地存储 |

**⚠️ 第2层有任何问题，不要继续打包！**

---

## 📦 第3层：打包应用验证 (3-5分钟) ⭐⭐最终

**目的**: 确保打包后的应用在真实环境运行正常

### 步骤 A: 快速打包测试 (不生成安装包)

**命令**:
```bash
npm run verify:l3-quick
```

**预期输出**:
```
  • electron-builder  version=25.1.8 os=10.0.22631
  • building         target=win-unpacked dir=dist\win-unpacked
  • building         finished
```

**操作**:
1. 打开文件资源管理器
2. 导航到 `dist\win-unpacked\`
3. 双击运行 `待办事项管理.exe`

**测试清单** (简化版):
- [ ] 应用正常启动，不是白屏
- [ ] 能创建、编辑、删除任务
- [ ] 拖拽功能正常
- [ ] 关闭应用后重新打开，数据还在

**如果快速测试失败**:
- 查看 `dist\win-unpacked\` 下是否有日志文件
- 检查 electron.js 配置

### 步骤 B: 完整安装测试

**命令**:
```bash
npm run build-electron-win-unsigned
```

**预期输出**:
```
dist\todo-app-setup-0.2.0.exe  (约100MB)
```

**操作**:
1. 卸载旧版本（如果已安装）
2. 双击运行安装程序
3. 选择安装目录
4. 完成安装
5. 从桌面或开始菜单启动应用

**完整测试清单**:

**安装测试**:
- [ ] 安装程序正常启动
- [ ] 可以选择安装目录
- [ ] 创建桌面快捷方式
- [ ] 安装完成提示

**首次启动**:
- [ ] 应用正常启动
- [ ] 不是白屏
- [ ] 界面显示正常
- [ ] 默认显示本周或今天

**功能测试** (创建几个测试任务):
- [ ] 创建一个"紧急"任务（红色）
- [ ] 创建一个"普通"任务（蓝色）
- [ ] 编辑任务，修改描述
- [ ] 拖拽任务调整时间
- [ ] 删除一个任务

**数据持久化测试**:
- [ ] 关闭应用
- [ ] 重新启动应用
- [ ] 确认所有任务都还在

**视图切换**:
- [ ] 切换到月视图
- [ ] 切换回周视图
- [ ] 点击"回到今天"按钮

**导出/导入** (如果有此功能):
- [ ] 导出任务数据
- [ ] 删除所有任务
- [ ] 导入刚才导出的数据
- [ ] 确认数据恢复成功

### 常见问题排查

| 症状 | 可能原因 | 解决方案 |
|------|---------|---------|
| 安装后白屏 | 路径配置问题 | 检查 electron.js 的 `loadFile` 路径 |
| 应用无法启动 | 缺少运行时 | 检查 electron-builder 配置 |
| 数据不保存 | localStorage 问题 | 检查 webPreferences 配置 |
| 应用崩溃 | 渲染进程错误 | 启用生产环境日志查看 |

### 启用生产环境调试

如果打包后有问题，修改 `public/electron.js`：

```javascript
if (isPackaged) {
  // 生产环境打开开发者工具（调试用）
  mainWindow.webContents.openDevTools();
  mainWindow.loadFile(path.join(__dirname, './index.html'));
}
```

调试完成后记得删除或注释掉 `openDevTools()`！

---

## ✅ 发布前最终检查清单

在所有验证通过后，发布前最后检查：

**版本信息**:
- [ ] `package.json` 中的 `version` 已更新
- [ ] 发布标签使用项目名称后缀，如 `v0.2.0-timeline`

**文件检查**:
- [ ] `dist/todomanagement-setup-{version}.exe` 存在
- [ ] 文件大小合理（约 90-110MB）

**Git 提交**:
- [ ] 代码已提交到 GitHub
- [ ] 提交信息清晰描述了改动

**GitHub Release**:
- [ ] 创建新的 Release
- [ ] 标签格式：`v{version}-timeline`
- [ ] 上传 exe 文件
- [ ] 添加 Release 说明

---

## 🚀 推荐工作流程

### 日常开发流程
```
代码修改 → npm run electron-dev → 测试 → 提交代码
```

### 发布流程 (约5分钟)
```
1. 代码修改完成
   ↓
2. npm run verify:l1  (30秒)
   - 失败 → 修复代码
   ↓
3. npm run verify:l2  (2-3分钟)
   - 打开浏览器 http://localhost:5000
   - 测试所有功能
   - 失败 → 修复后重新开始
   ↓
4. npm run verify:l3-quick  (1分钟)
   - 运行 dist\win-unpacked\待办事项管理.exe
   - 快速功能测试
   - 失败 → 查看日志，修复后重新开始
   ↓
5. npm run build-electron-win-unsigned  (2分钟)
   - 安装测试
   - 完整功能验证
   - 失败 → 修复后重新开始
   ↓
6. 上传到 GitHub ✅
```

---

## 📊 验证时间估算

| 验证层级 | 耗时 | 是否必需 | 备注 |
|---------|------|---------|------|
| 第1层 | 30秒 | ✅ 必须 | 编译检查 |
| 第2层 | 2-3分钟 | ✅ 必须 | 关键验证，捕捉80%问题 |
| 第3层-快速 | 1分钟 | ✅ 推荐 | 快速打包测试 |
| 第3层-完整 | 3-5分钟 | ✅ 发布前必做 | 完整安装测试 |
| **总计** | **5-10分钟** | - | 发布前总耗时 |

---

## 🆘 故障排查指南

### 问题1: 第2层验证通过，第3层白屏

**原因**: Electron 环境和浏览器环境差异

**排查**:
```javascript
// 在 public/electron.js 中添加调试代码
mainWindow.webContents.on('did-fail-load', (event, errorCode, errorDescription) => {
  console.error('加载失败:', errorCode, errorDescription);
});
```

**解决**: 检查 `loadFile` 的路径是否正确

### 问题2: 数据在浏览器正常，打包后丢失

**原因**: localStorage 在 Electron 中的存储位置不同

**解决**:
```javascript
// public/electron.js
webPreferences: {
  nodeIntegration: true,
  contextIsolation: false,
  // 确保 localStorage 可用
}
```

### 问题3: 打包后文件体积异常大

**检查**:
```bash
# 查看 dist 内容
dir dist

# 检查是否包含了不必要的文件
```

**解决**: 修改 `package.json` 的 `build.files` 配置

---

## 📌 关键要点

1. **第2层验证是关键** - 80% 的问题在这里发现
2. **不要跳过任何一层** - 每一层都有独特价值
3. **验证失败不要继续** - 修复后重新开始
4. **宁多勿缺** - 多花5分钟，避免用户下载后发现问题

---

## 🎓 总结

**验证机制的核心价值**:
- ✅ 提前发现问题，避免用户反馈
- ✅ 每一层都捕捉特定类型的问题
- ✅ 总耗时 5-10 分钟，但能节省数小时的排查时间
- ✅ 建立信心：本地通过 = GitHub 可用

**下次发布时，按照这个流程操作，就能确保万无一失！**
